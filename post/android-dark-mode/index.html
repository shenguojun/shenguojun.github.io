<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Android深色模式适配原理分析 - Lawrence&#39;s Blog</title>
  <meta name="description" content="背景 从Android10（API 29）开始，在原有的主题适配的基础上，Google开始提供了Force Dark机制，在系统底层直接对颜色和图">
  <meta name="author" content="申国骏"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "Lawrence\x27s Blog",
    
    "url": "https:\/\/shenguojun.github.io\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/shenguojun.github.io\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/shenguojun.github.io\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/shenguojun.github.io\/post\/android-dark-mode\/",
          "name": "Android深色模式适配原理分析"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "申国骏"
  },
  "headline": "Android深色模式适配原理分析",
  "description" : "背景 从Android10（API 29）开始，在原有的主题适配的基础上，Google开始提供了Force Dark机制，在系统底层直接对颜色和图",
  "inLanguage" : "en",
  "wordCount":  10958 ,
  "datePublished" : "2020-10-12T13:06:52",
  "dateModified" : "2020-10-12T13:06:52",
  "image" : "https:\/\/shenguojun.github.io\/image\/bugzongchai.png",
  "keywords" : [ "android" ],
  "mainEntityOfPage" : "https:\/\/shenguojun.github.io\/post\/android-dark-mode\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/shenguojun.github.io\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/shenguojun.github.io\/image\/bugzongchai.png",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="Android深色模式适配原理分析" />
<meta property="og:description" content="背景 从Android10（API 29）开始，在原有的主题适配的基础上，Google开始提供了Force Dark机制，在系统底层直接对颜色和图">
<meta property="og:image" content="https://shenguojun.github.io/image/bugzongchai.png" />
<meta property="og:url" content="https://shenguojun.github.io/post/android-dark-mode/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Lawrence&#39;s Blog" />

  <meta name="twitter:title" content="Android深色模式适配原理分析" />
  <meta name="twitter:description" content="背景 从Android10（API 29）开始，在原有的主题适配的基础上，Google开始提供了Force Dark机制，在系统底层直接对颜色和图">
  <meta name="twitter:image" content="https://shenguojun.github.io/image/bugzongchai.png" />
  <meta name="twitter:card" content="summary" />
  <link href='https://shenguojun.github.io/image/bugzongchai.png' rel='icon' type='image/x-icon'/>
  <meta name="generator" content="Hugo 0.68.3" />
  <link rel="alternate" href="https://shenguojun.github.io/index.xml" type="application/rss+xml" title="Lawrence&#39;s Blog"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><link rel="stylesheet" href="https://shenguojun.github.io/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://shenguojun.github.io/css/highlight.min.css" /><link rel="stylesheet" href="https://shenguojun.github.io/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-162790364-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://shenguojun.github.io/">Lawrence&#39;s Blog</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Blog" href="/">Blog</a>
            </li>
          
        
          
            <li>
              <a title="About" href="/page/about/">About</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="/tags">Tags</a>
            </li>
          
        

        

        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="Lawrence&#39;s Blog" href="https://shenguojun.github.io/">
            <img class="avatar-img" src="https://shenguojun.github.io/image/bugzongchai.png" alt="Lawrence&#39;s Blog" />
          </a>
        </div>
      </div>
    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading text-center">
              
                <h1>Android深色模式适配原理分析</h1>
              
              
              
              
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on October 12, 2020
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;22&nbsp;minutes
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;10958&nbsp;words
  
  
    
      &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;申国骏
    
  
  
</span>


              
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <h1>TOC</h1>
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#背景">背景</a></li>
        <li><a href="#资源配置限定符">资源配置限定符</a></li>
        <li><a href="#深色模式判断设置">深色模式判断&amp;设置</a>
          <ul>
            <li><a href="#判断当前是否深色模式">判断当前是否深色模式</a></li>
            <li><a href="#判断当前深色模式场景">判断当前深色模式场景</a></li>
            <li><a href="#模式设置">模式设置</a></li>
          </ul>
        </li>
        <li><a href="#适配方案">适配方案</a>
          <ul>
            <li><a href="#自定义适配">自定义适配</a></li>
            <li><a href="#force-dark">Force Dark</a></li>
          </ul>
        </li>
        <li><a href="#总结">总结</a></li>
        <li><a href="#demo">Demo</a></li>
        <li><a href="#参考">参考</a></li>
      </ul>
    </li>
  </ul>
</nav>

        <p><img src="https://raw.githubusercontent.com/shenguojun/ImageServer/master/uPic/dark-mode-hot-take.png" alt="Dark Mode"></p>
<h2 id="背景">背景</h2>
<p>从Android10（API 29）开始，在原有的主题适配的基础上，Google开始提供了Force Dark机制，在系统底层直接对颜色和图片进行转换处理，原生支持深色模式。到目前为止，我们从用户数据分析**50%**以上的用户已经使用上了Android10系统。深色模式可以节省电量、改善弱势及强光敏感用户的可视性，并能在环境亮度较暗的时候保护视力，更是夜间活跃用户的强烈需求。对深色模式的适配有利于提升用户口碑。 转载请注明来源<a href="https://www.jianshu.com/u/b692bbf77991">「申国骏」</a></p>
<p>深色模式在安卓上可以分为以下四种场景：</p>
<ul>
<li>
<p>强制深色模式</p>
</li>
<li>
<p>强制浅色模式</p>
</li>
<li>
<p>跟随系统</p>
</li>
<li>
<p>低电量自动切换深色</p>
</li>
</ul>
<p>以下将介绍如何设置深色模式以及如何对深色模式进行适配。</p>
<h2 id="资源配置限定符">资源配置限定符</h2>
<p>我们常见的需要设置的资源有<code>drawable</code>、<code>layout</code>、<code>mipmap</code>和<code>values</code>等，对于这些资源，我们可以用一些限定符来表示提供一些备用资源，例如<code>drawable-xhdpi</code>表示超密度屏幕使用的资源，或者<code>layout-land</code>表示横向状态使用的布局。</p>
<p>同样的深色模式可以使用资源的限定符<code>-night</code>来表示在深色模式中使用的资源。如下图所示：</p>
<p><!-- raw HTML omitted --></p>
<p><!-- raw HTML omitted --></p>
<p>使用了<code>-night</code>限定符的文件夹里面的资源我们称为<code>night</code>资源，没有使用<code>-night</code>限定符的资源我们称为<code>notnight</code>资源。</p>
<p>其中<code>drawable-night-xhdpi</code>可以放置对应超密度屏幕使用的深色模式的图片，<code>values-night</code>可以声明对应深色模式使用的色值和主题。</p>
<p>所有的资源限定符定义以及添加的顺序（例如<code>-night</code>必须在<code>-xhdpi</code>之前）可查看<a href="https://developer.android.com/guide/topics/resources/providing-resources">应用资源概览</a>中的<a href="https://developer.android.com/guide/topics/resources/providing-resources#QualifierRules">配置限定符名称表</a>。</p>
<h2 id="深色模式判断设置">深色模式判断&amp;设置</h2>
<h3 id="判断当前是否深色模式">判断当前是否深色模式</h3>
<p><a href="https://developer.android.com/reference/android/content/res/Configuration#uiMode">Configuration.uiMode </a>有三种NIGHT的模式</p>
<ul>
<li><a href="https://developer.android.com/reference/android/content/res/Configuration#UI_MODE_NIGHT_NO">UI_MODE_NIGHT_NO </a>表示当前使用的是<code>notnight</code>模式资源</li>
<li><a href="https://developer.android.com/reference/android/content/res/Configuration#UI_MODE_NIGHT_YES">UI_MODE_NIGHT_YES</a> 表示当前使用的是<code>night</code>模式资源</li>
<li><a href="https://developer.android.com/reference/android/content/res/Configuration#UI_MODE_NIGHT_UNDEFINED">UI_MODE_NIGHT_UNDEFINED</a> 表示当前没有设置模式</li>
</ul>
<p>可以通过以下的代码来判断当前是否处于深色模式：</p>
<div class="highlight"><pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="cm">/**
</span><span class="cm"> * 判断当前是否深色模式
</span><span class="cm"> *
</span><span class="cm"> * @return 深色模式返回 true，否则返回false
</span><span class="cm"> */</span>
<span class="k">fun</span> <span class="nf">isNightMode</span><span class="p">():</span> <span class="n">Boolean</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">when</span> <span class="p">(</span><span class="n">resources</span><span class="p">.</span><span class="n">configuration</span><span class="p">.</span><span class="n">uiMode</span> <span class="n">and</span> <span class="n">Configuration</span><span class="p">.</span><span class="n">UI_MODE_NIGHT_MASK</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Configuration</span><span class="p">.</span><span class="n">UI_MODE_NIGHT_YES</span> <span class="p">-&gt;</span> <span class="k">true</span>
    <span class="k">else</span> <span class="p">-&gt;</span> <span class="k">false</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p><em>Tips: 对于一些从网络接口服务获取的需要对深色模式区分的色值或者图片，可以使用上述的判断来获取对应的资源。</em></p>
<h3 id="判断当前深色模式场景">判断当前深色模式场景</h3>
<p>通过<a href="https://developer.android.com/reference/androidx/appcompat/app/AppCompatDelegate#getDefaultNightMode()">AppCompatDelegate.getDefaultNightMode()</a>可以获取五种深色模式场景：</p>
<ul>
<li><a href="https://developer.android.com/reference/androidx/appcompat/app/AppCompatDelegate#MODE_NIGHT_AUTO_BATTERY">MODE_NIGHT_AUTO_BATTERY</a> 低电量模式自动开启深色模式</li>
<li><a href="https://developer.android.com/reference/androidx/appcompat/app/AppCompatDelegate#MODE_NIGHT_FOLLOW_SYSTEM">MODE_NIGHT_FOLLOW_SYSTEM</a> 跟随系统开启和关闭深色模式（默认）</li>
<li><a href="https://developer.android.com/reference/androidx/appcompat/app/AppCompatDelegate#MODE_NIGHT_NO">MODE_NIGHT_NO</a> 强制使用<code>notnight</code>资源，表示非深色模式</li>
<li><a href="https://developer.android.com/reference/androidx/appcompat/app/AppCompatDelegate#MODE_NIGHT_YES">MODE_NIGHT_YES</a> 强制使用<code>night</code>资源</li>
<li><a href="https://developer.android.com/reference/androidx/appcompat/app/AppCompatDelegate#MODE_NIGHT_UNSPECIFIED">MODE_NIGHT_UNSPECIFIED</a> 配合 <a href="https://developer.android.com/reference/androidx/appcompat/app/AppCompatDelegate#setLocalNightMode(int)">setLocalNightMode(int)</a> 使用，表示由Activity通过<a href="https://developer.android.com/reference/kotlin/androidx/appcompat/app/AppCompatActivity#getdelegate">AppCompactActivity.getDelegate()</a>来单独设置页面的深色模式，不设置全局模式</li>
</ul>
<h3 id="模式设置">模式设置</h3>
<p>深色模式设置可以从三个层级设置，分别是系统层、Applcation层以及Activity层。底层的设置会覆盖上层的设置，例如系统设置了深色模式，但是Application设置了浅色模式，那么应用会显示浅色主题。</p>
<p><!-- raw HTML omitted --></p>
<p>系统层是指系统设置中，根据不同产商的手机，可以在设置-&gt;显示中修改系统为深色模式。</p>
<p>Application层通过<code>AppCompatDelegate.setDefaultNightMode()</code>设置深色模式。</p>
<p>Activity层通过<a href="https://developer.android.com/reference/androidx/appcompat/app/AppCompatDelegate.html#setLocalNightMode(int)">getDelegate().setLocalNightMode()</a>设置深色模式。</p>
<p>当深色模式改变时，Activity会重建，如果不希望Activity重建，可以在<code>AndroidManifest.xml</code>中对对应的Activity设置<code>android:configChanges=&quot;uiMode&quot;</code>，不过设置之后页面的颜色改变需要Activity在中通过监听<code>onConfigurationChanged</code>来动态改变。</p>
<p>通过<a href="https://developer.android.com/reference/androidx/appcompat/app/AppCompatDelegate#setDefaultNightMode(int)">AppCompatDelegate.setDefaultNightMode(int)</a>可以设置深色模式，源码如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setDefaultNightMode</span><span class="o">(</span><span class="nd">@NightMode</span> <span class="kt">int</span> <span class="n">mode</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&#34;setDefaultNightMode. New:%d, Current:%d&#34;</span><span class="o">,</span>
                             <span class="n">mode</span><span class="o">,</span> <span class="n">sDefaultNightMode</span><span class="o">));</span>
  <span class="o">}</span>
  <span class="k">switch</span> <span class="o">(</span><span class="n">mode</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">MODE_NIGHT_NO</span><span class="o">:</span>
    <span class="k">case</span> <span class="n">MODE_NIGHT_YES</span><span class="o">:</span>
    <span class="k">case</span> <span class="n">MODE_NIGHT_FOLLOW_SYSTEM</span><span class="o">:</span>
    <span class="k">case</span> <span class="n">MODE_NIGHT_AUTO_TIME</span><span class="o">:</span>
    <span class="k">case</span> <span class="n">MODE_NIGHT_AUTO_BATTERY</span><span class="o">:</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">sDefaultNightMode</span> <span class="o">!=</span> <span class="n">mode</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">sDefaultNightMode</span> <span class="o">=</span> <span class="n">mode</span><span class="o">;</span>
        <span class="n">applyDayNightToActiveDelegates</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="k">break</span><span class="o">;</span>
    <span class="k">default</span><span class="o">:</span>
      <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;setDefaultNightMode() called with an unknown mode&#34;</span><span class="o">);</span>
      <span class="k">break</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>从源码可以看出设置 <a href="https://developer.android.com/reference/androidx/appcompat/app/AppCompatDelegate#MODE_NIGHT_UNSPECIFIED">MODE_NIGHT_UNSPECIFIED</a> 模式是不会生效的。</p>
<p><em>Tips：注意，深色模式变化会导致Activity重建。</em></p>
<h2 id="适配方案">适配方案</h2>
<h3 id="自定义适配">自定义适配</h3>
<h4 id="1-主题">1. 主题</h4>
<p>将Application和Activity的主题修改为集成自<code>Theme.AppCompat.DayNight</code>或者<code>Theme.MaterialComponents.DayNight</code>，就可以对于大部分的控件得到较好的深色模式支持。我们看下DayNight主题的定义：</p>
<p><img src="https://raw.githubusercontent.com/shenguojun/ImageServer/master/uPic/image-20200908171815954.png" alt="image-20200908171815954"></p>
<p>​	<strong>res/values/values.xml</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
<span class="nt">&lt;resources</span> <span class="na">xmlns:ns1=</span><span class="s">&#34;urn:oasis:names:tc:xliff:document:1.2&#34;</span><span class="nt">&gt;</span>		
    <span class="ni">&amp;lt;</span>-- ... --&gt;
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.AppCompat.DayNight&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.AppCompat.Light&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.AppCompat.DayNight.DarkActionBar&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.AppCompat.Light.DarkActionBar&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.AppCompat.DayNight.Dialog&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.AppCompat.Light.Dialog&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.AppCompat.DayNight.Dialog.Alert&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.AppCompat.Light.Dialog.Alert&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.AppCompat.DayNight.Dialog.MinWidth&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.AppCompat.Light.Dialog.MinWidth&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.AppCompat.DayNight.DialogWhenLarge&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.AppCompat.Light.DialogWhenLarge&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.AppCompat.DayNight.NoActionBar&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.AppCompat.Light.NoActionBar&#34;</span><span class="nt">/&gt;</span>
    <span class="ni">&amp;lt;</span>-- ... --&gt;
<span class="nt">&lt;/resources&gt;</span>
</code></pre></div><p>​	<strong>res/values-night-v8/values-night-v8.xml</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
<span class="nt">&lt;resources&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.AppCompat.DayNight&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.AppCompat&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.AppCompat.DayNight.DarkActionBar&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.AppCompat&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.AppCompat.DayNight.Dialog&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.AppCompat.Dialog&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.AppCompat.DayNight.Dialog.Alert&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.AppCompat.Dialog.Alert&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.AppCompat.DayNight.Dialog.MinWidth&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.AppCompat.Dialog.MinWidth&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.AppCompat.DayNight.DialogWhenLarge&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.AppCompat.DialogWhenLarge&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.AppCompat.DayNight.NoActionBar&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.AppCompat.NoActionBar&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;ThemeOverlay.AppCompat.DayNight&#34;</span> <span class="na">parent=</span><span class="s">&#34;ThemeOverlay.AppCompat.Dark&#34;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/resources&gt;</span>
</code></pre></div><p><img src="https://raw.githubusercontent.com/shenguojun/ImageServer/master/uPic/image-20200908171758720.png" alt="image-20200908171758720"></p>
<p>​	<strong>res/values/values.xml</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
<span class="nt">&lt;resources</span> <span class="na">xmlns:ns1=</span><span class="s">&#34;urn:oasis:names:tc:xliff:document:1.2&#34;</span> <span class="na">xmlns:ns2=</span><span class="s">&#34;http://schemas.android.com/tools&#34;</span><span class="nt">&gt;</span>
    <span class="ni">&amp;lt;</span>-- ... --&gt;
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.MaterialComponents.DayNight&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.MaterialComponents.Light&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.MaterialComponents.DayNight.BottomSheetDialog&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.MaterialComponents.Light.BottomSheetDialog&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.MaterialComponents.DayNight.Bridge&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.MaterialComponents.Light.Bridge&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.MaterialComponents.DayNight.DarkActionBar&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.MaterialComponents.Light.DarkActionBar&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.MaterialComponents.DayNight.DarkActionBar.Bridge&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.MaterialComponents.Light.DarkActionBar.Bridge&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.MaterialComponents.DayNight.Dialog&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.MaterialComponents.Light.Dialog&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.MaterialComponents.DayNight.Dialog.Alert&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.MaterialComponents.Light.Dialog.Alert&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.MaterialComponents.DayNight.Dialog.Alert.Bridge&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.MaterialComponents.Light.Dialog.Alert.Bridge&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.MaterialComponents.DayNight.Dialog.Bridge&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.MaterialComponents.Light.Dialog.Bridge&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.MaterialComponents.DayNight.Dialog.FixedSize&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.MaterialComponents.Light.Dialog.FixedSize&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.MaterialComponents.DayNight.Dialog.FixedSize.Bridge&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.MaterialComponents.Light.Dialog.FixedSize.Bridge&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.MaterialComponents.DayNight.Dialog.MinWidth&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.MaterialComponents.Light.Dialog.MinWidth&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.MaterialComponents.DayNight.Dialog.MinWidth.Bridge&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.MaterialComponents.Light.Dialog.MinWidth.Bridge&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.MaterialComponents.DayNight.DialogWhenLarge&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.MaterialComponents.Light.DialogWhenLarge&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.MaterialComponents.DayNight.NoActionBar&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.MaterialComponents.Light.NoActionBar&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.MaterialComponents.DayNight.NoActionBar.Bridge&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.MaterialComponents.Light.NoActionBar.Bridge&#34;</span><span class="nt">/&gt;</span>
    <span class="ni">&amp;lt;</span>-- ... --&gt;
<span class="nt">&lt;/resources&gt;</span>
</code></pre></div><p>​	<strong>res/values-night-v8/values-night-v8.xml</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
<span class="nt">&lt;resources&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.MaterialComponents.DayNight&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.MaterialComponents&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.MaterialComponents.DayNight.BottomSheetDialog&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.MaterialComponents.BottomSheetDialog&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.MaterialComponents.DayNight.Bridge&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.MaterialComponents.Bridge&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.MaterialComponents.DayNight.DarkActionBar&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.MaterialComponents&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.MaterialComponents.DayNight.DarkActionBar.Bridge&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.MaterialComponents.Bridge&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.MaterialComponents.DayNight.Dialog&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.MaterialComponents.Dialog&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.MaterialComponents.DayNight.Dialog.Alert&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.MaterialComponents.Dialog.Alert&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.MaterialComponents.DayNight.Dialog.Alert.Bridge&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.MaterialComponents.Dialog.Alert.Bridge&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.MaterialComponents.DayNight.Dialog.Bridge&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.MaterialComponents.Dialog.Bridge&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.MaterialComponents.DayNight.Dialog.FixedSize&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.MaterialComponents.Dialog.FixedSize&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.MaterialComponents.DayNight.Dialog.FixedSize.Bridge&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.MaterialComponents.Dialog.FixedSize.Bridge&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.MaterialComponents.DayNight.Dialog.MinWidth&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.MaterialComponents.Dialog.MinWidth&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.MaterialComponents.DayNight.Dialog.MinWidth.Bridge&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.MaterialComponents.Dialog.MinWidth.Bridge&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.MaterialComponents.DayNight.DialogWhenLarge&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.MaterialComponents.DialogWhenLarge&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.MaterialComponents.DayNight.NoActionBar&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.MaterialComponents.NoActionBar&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.MaterialComponents.DayNight.NoActionBar.Bridge&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.MaterialComponents.NoActionBar.Bridge&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;ThemeOverlay.MaterialComponents.DayNight.BottomSheetDialog&#34;</span> <span class="na">parent=</span><span class="s">&#34;ThemeOverlay.MaterialComponents.BottomSheetDialog&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Widget.MaterialComponents.ActionBar.PrimarySurface&#34;</span> <span class="na">parent=</span><span class="s">&#34;Widget.MaterialComponents.ActionBar.Surface&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Widget.MaterialComponents.AppBarLayout.PrimarySurface&#34;</span> <span class="na">parent=</span><span class="s">&#34;Widget.MaterialComponents.AppBarLayout.Surface&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Widget.MaterialComponents.BottomAppBar.PrimarySurface&#34;</span> <span class="na">parent=</span><span class="s">&#34;Widget.MaterialComponents.BottomAppBar&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Widget.MaterialComponents.BottomNavigationView.PrimarySurface&#34;</span> <span class="na">parent=</span><span class="s">&#34;Widget.MaterialComponents.BottomNavigationView&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Widget.MaterialComponents.TabLayout.PrimarySurface&#34;</span> <span class="na">parent=</span><span class="s">&#34;Widget.MaterialComponents.TabLayout&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Widget.MaterialComponents.Toolbar.PrimarySurface&#34;</span> <span class="na">parent=</span><span class="s">&#34;Widget.MaterialComponents.Toolbar.Surface&#34;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/resources&gt;</span>
</code></pre></div><p><em>Tips: MaterialComponents.Bridge继承自AppCompat主题，并增加了Material Components的主题属性，如果项目之前是用的AppCompat，那么使用对应的Bridge主题可以快速切换到Material Design。</em></p>
<p>从上面的分析可以看出，DayNight就是在values以及values-night中分别定义了浅色和深色的主题。如果我们的主题直接继承DayNight主题，那么就不需要重复地声明对应的<code>night</code>主题资源了。</p>
<p>如果我们想对深色模式主题添加自定义属性，那么我们可以不继承DayNight主题，并显示地声明主题对应的<code>night</code>资源，例如</p>
<p>​	<strong>res/values/themes.xml</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.MyApp&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.MaterialComponents.Light&#34;</span><span class="nt">&gt;</span>
    <span class="ni">&amp;lt;</span>-- ... --&gt;
    <span class="nt">&lt;item</span> <span class="na">name=</span><span class="s">&#34;android:windowLightStatusBar&#34;</span><span class="nt">&gt;</span>true<span class="nt">&lt;/item&gt;</span>
<span class="nt">&lt;/style&gt;</span>
</code></pre></div><p>​	<strong>res/values-night/themes.xml</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;Theme.MyApp&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.MaterialComponents&#34;</span><span class="nt">&gt;</span>
    <span class="ni">&amp;lt;</span>-- ... --&gt;
    <span class="nt">&lt;item</span> <span class="na">name=</span><span class="s">&#34;android:windowLightStatusBar&#34;</span><span class="nt">&gt;</span>false<span class="nt">&lt;/item&gt;</span>
<span class="nt">&lt;/style&gt;</span>
</code></pre></div><p><em>Tips: 若需要动态修改主题要在调用inflate之前调用，否则不会生效。</em></p>
<h4 id="2-色值">2. 色值</h4>
<h5 id="主题切换颜色">主题切换颜色</h5>
<p>除了定义不同模式使用不同的主题，我们还可以对主题设置自定义的色值。在设置主题色值之前，我们先了解一下Android主题的颜色系统。</p>
<p><!-- raw HTML omitted --></p>
<ul>
<li>colorPrimary：主要品牌颜色，一般用于ActionBar背景</li>
<li>colorPrimaryDark：默认用于顶部状态栏和底部导航栏</li>
<li>colorPrimaryVariant：主要品牌颜色的可选颜色</li>
<li>colorSecondary：第二品牌颜色</li>
<li>colorSecondaryVariant：第二品牌颜色的可选颜色</li>
<li>colorPrimarySurface：对应Light主题指向colorPrimary，Dark主题指向colorSurface</li>
<li>colorOn[Primary, Secondary, Surface &hellip;]，在Primary等这些背景的上面内容的颜色，例如ActioBar上面的文字颜色</li>
<li>colorAccent：默认设置给colorControlActivated，一般是主要品牌颜色的明亮版本补充</li>
<li>colorControlNormal：图标和控制项的正常状态颜色</li>
<li>colorControlActivated：图标和控制项的选中颜色（例如Checked或者Switcher）</li>
<li>colorControlHighlight：点击高亮效果（ripple或者selector）</li>
<li>colorButtonNormal：按钮默认状态颜色</li>
<li>colorSurface：cards, sheets, menus等控件的背景颜色</li>
<li>colorBackground：页面的背景颜色</li>
<li>colorError：展示错误的颜色</li>
<li>textColorPrimary：主要文字颜色</li>
<li>textColorSecondary：可选文字颜色</li>
</ul>
<p><em>Tips: 当某个属性同时可以通过 <code>?attr/xxx</code> 或者<code> ?android:attr/xxx</code>获取时，最好使用<code> ?attr/xxx</code>，因为<code>?android:attr/xxx</code>是通过系统获取，而<code>?attr/xxx</code>是通过静态库类似于AppCompat 或者 Material Design Component引入的。使用非系统版本的属性可以提高平台通用性。</em></p>
<p>如果需要自定义主题颜色，我们可以对颜色分别定义<code>notnight</code>和<code>night</code>两份，放在<code>values</code>以及<code>values-night</code>资源文件夹中，并在自定义主题时，传入给对应的颜色属性。例如：</p>
<p>​	<strong>res/values/styles.xml</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;resources&gt;</span>
    <span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;DayNightAppTheme&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.MaterialComponents.DayNight.NoActionBar.Bridge&#34;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;item</span> <span class="na">name=</span><span class="s">&#34;colorPrimary&#34;</span><span class="nt">&gt;</span>@color/color_bg_1<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item</span> <span class="na">name=</span><span class="s">&#34;colorPrimaryDark&#34;</span><span class="nt">&gt;</span>@color/color_bg_1<span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item</span> <span class="na">name=</span><span class="s">&#34;colorAccent&#34;</span><span class="nt">&gt;</span>@color/color_main_1<span class="nt">&lt;/item&gt;</span>
    <span class="nt">&lt;/style&gt;</span>
<span class="nt">&lt;/resources&gt;</span>
</code></pre></div><p>​	<strong>res/values/colors.xml</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
<span class="nt">&lt;resources&gt;</span>
    <span class="nt">&lt;color</span> <span class="na">name=</span><span class="s">&#34;color_main_1&#34;</span><span class="nt">&gt;</span>#4D71FF<span class="nt">&lt;/color&gt;</span>
    <span class="nt">&lt;color</span> <span class="na">name=</span><span class="s">&#34;color_bg_1&#34;</span><span class="nt">&gt;</span>#FFFFFF<span class="nt">&lt;/color&gt;</span>
    <span class="nt">&lt;color</span> <span class="na">name=</span><span class="s">&#34;color_text_0&#34;</span><span class="nt">&gt;</span>#101214<span class="nt">&lt;/color&gt;</span>
    <span class="nt">&lt;color</span> <span class="na">name=</span><span class="s">&#34;color_light&#34;</span><span class="nt">&gt;</span>#E0A62E<span class="nt">&lt;/color&gt;</span>
<span class="nt">&lt;/resources&gt;</span>
</code></pre></div><p>​	<strong>res/values-night/colors.xml</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
<span class="nt">&lt;resources&gt;</span>
    <span class="nt">&lt;color</span> <span class="na">name=</span><span class="s">&#34;color_main_1&#34;</span><span class="nt">&gt;</span>#FF584D<span class="nt">&lt;/color&gt;</span>
    <span class="nt">&lt;color</span> <span class="na">name=</span><span class="s">&#34;color_bg_1&#34;</span><span class="nt">&gt;</span>#0B0C0D<span class="nt">&lt;/color&gt;</span>
    <span class="nt">&lt;color</span> <span class="na">name=</span><span class="s">&#34;color_text_0&#34;</span><span class="nt">&gt;</span>#F5F7FA<span class="nt">&lt;/color&gt;</span>
    <span class="nt">&lt;color</span> <span class="na">name=</span><span class="s">&#34;color_light&#34;</span><span class="nt">&gt;</span>#626469<span class="nt">&lt;/color&gt;</span>
<span class="nt">&lt;/resources&gt;</span>
</code></pre></div><h5 id="控件切换颜色">控件切换颜色</h5>
<p>同样的，我们可以在布局的XML文件中直接使用定义好的颜色值，例如</p>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;TextView</span> 
      <span class="na">android:id=</span><span class="s">&#34;@+id/auto_color_text&#34;</span>
      <span class="na">android:text=</span><span class="s">&#34;自定义变色文字&#34;</span>
      <span class="na">android:background=</span><span class="s">&#34;@drawable/bg_text&#34;</span>
      <span class="na">android:textColor=</span><span class="s">&#34;@color/color_text_0&#34;</span> <span class="nt">/&gt;</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
<span class="nt">&lt;shape</span> <span class="na">xmlns:android=</span><span class="s">&#34;http://schemas.android.com/apk/res/android&#34;</span>
    <span class="na">android:shape=</span><span class="s">&#34;rectangle&#34;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;stroke</span> <span class="na">android:color=</span><span class="s">&#34;@color/color_text_0&#34;</span> <span class="na">android:width=</span><span class="s">&#34;2dp&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;solid</span> <span class="na">android:color=</span><span class="s">&#34;@color/color_bg_1&#34;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/shape&gt;</span>
</code></pre></div><p>这样这个文字就会在深色模式中展示为黑底白字，在非深色模式中展示为白底黑字。</p>
<p><!-- raw HTML omitted --></p>
<p><!-- raw HTML omitted --></p>
<h5 id="动态设置颜色">动态设置颜色</h5>
<p>如果需要代码设置颜色，如果色值已经设置过<code>notnight</code>和<code>night</code>两份，那么直接设置颜色就可以得到深色模式变色效果。</p>
<div class="highlight"><pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="n">auto_color_text</span><span class="p">.</span><span class="n">setTextColor</span><span class="p">(</span><span class="n">ContextCompat</span><span class="p">.</span><span class="n">getColor</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">R</span><span class="p">.</span><span class="n">color</span><span class="p">.</span><span class="n">color_text_0</span><span class="p">))</span>
</code></pre></div><p>如果色值是从服务接口获取，那么可以使用上述深色模式的判断设置。</p>
<div class="highlight"><pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="n">auto_color_text</span><span class="p">.</span><span class="n">setTextColor</span><span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="n">isNightMode</span><span class="p">())</span> <span class="p">{</span>
  <span class="n">Color</span><span class="p">.</span><span class="n">parseColor</span><span class="p">(</span><span class="n">darkColorFromNetwork</span><span class="p">)</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="n">Color</span><span class="p">.</span><span class="n">parseColor</span><span class="p">(</span><span class="n">colorFromNetwork</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div><h4 id="3-图片动画">3. 图片&amp;动画</h4>
<h5 id="普通图片gif图片">普通图片&amp;Gif图片</h5>
<p>将图片分为明亮模式和深色模式两份，分别放置在<code>drawable-night-xxx</code>以及<code>drawable-xxx</code>文件夹中，并在view中直接使用即可，当深色模式切换时，会使用对应深色模式的资源。如下图所示：</p>
<p><!-- raw HTML omitted --></p>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;ImageView</span> <span class="na">android:src=</span><span class="s">&#34;@drawable/round_fingerprint&#34;</span> <span class="nt">/&gt;</span>
</code></pre></div><h5 id="vector图片">Vector图片</h5>
<p>在Vector资源定义时，通过指定画笔颜色来实现对深色模式的适配，例如：</p>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;vector</span> <span class="na">xmlns:android=</span><span class="s">&#34;http://schemas.android.com/apk/res/android&#34;</span>
    <span class="na">android:width=</span><span class="s">&#34;24dp&#34;</span>
    <span class="na">android:height=</span><span class="s">&#34;24dp&#34;</span>
    <span class="na">android:tint=</span><span class="s">&#34;@color/color_light&#34;</span>
    <span class="na">android:viewportWidth=</span><span class="s">&#34;24&#34;</span>
    <span class="na">android:viewportHeight=</span><span class="s">&#34;24&#34;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;path</span>
        <span class="na">android:fillColor=</span><span class="s">&#34;@android:color/white&#34;</span>
        <span class="na">android:pathData=</span><span class="s">&#34;M6.29,14.29L9,17v4c0,0.55 0.45,1 1,1h4c0.55,0 1,-0.45 1,-1v-4l2.71,-2.71c0.19,-0.19 0.29,-0.44 0.29,-0.71L18,10c0,-0.55 -0.45,-1 -1,-1L7,9c-0.55,0 -1,0.45 -1,1v3.59c0,0.26 0.11,0.52 0.29,0.7zM12,2c0.55,0 1,0.45 1,1v1c0,0.55 -0.45,1 -1,1s-1,-0.45 -1,-1L11,3c0,-0.55 0.45,-1 1,-1zM4.21,5.17c0.39,-0.39 1.02,-0.39 1.42,0l0.71,0.71c0.39,0.39 0.39,1.02 0,1.41 -0.39,0.39 -1.02,0.39 -1.41,0l-0.72,-0.71c-0.39,-0.39 -0.39,-1.02 0,-1.41zM17.67,5.88l0.71,-0.71c0.39,-0.39 1.02,-0.39 1.41,0 0.39,0.39 0.39,1.02 0,1.41l-0.71,0.71c-0.39,0.39 -1.02,0.39 -1.41,0 -0.39,-0.39 -0.39,-1.02 0,-1.41z&#34;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/vector&gt;</span>
</code></pre></div><p>其中<code>android:tint</code>为叠加颜色，<code>@color/color_light</code>已经分别定义好了<code>notnight</code>和<code>night</code>的色值。</p>
<h5 id="lottie">Lottie</h5>
<p>对于<a href="http://airbnb.io/lottie/#/README">Lottie</a>动画，我们可以使用Lottie的<a href="http://airbnb.io/lottie/#/android?id=dynamic-properties">Dynamic Properties</a>特性来针对深色模式进行颜色变化。例如我们有以下两个动画，左边是由颜色填充的机器人，右边是由描边生成的正在播放动画，我们可以调用<code>LottieAnimationView.resolveKeyPath()</code>方法获取动画的路径。</p>
<p><!-- raw HTML omitted --></p>
<p><!-- raw HTML omitted --></p>
<div class="highlight"><pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="n">lottie_android_animate</span><span class="p">.</span><span class="n">addLottieOnCompositionLoadedListener</span> <span class="p">{</span>
  <span class="n">lottie_android_animate</span><span class="p">.</span><span class="n">resolveKeyPath</span><span class="p">(</span><span class="n">KeyPath</span><span class="p">(</span><span class="s">&#34;**&#34;</span><span class="p">)).</span><span class="n">forEach</span> <span class="p">{</span>
    <span class="n">Log</span><span class="p">.</span><span class="n">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">keysToString</span><span class="p">())</span>
  <span class="p">}</span>
  <span class="n">setupValueCallbacks</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div><p>对于机器小人打印的KeyPath如下：</p>
<pre><code>2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [MasterController]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [Head]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [Head, Group 3]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [Head, Group 3, Fill 1]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [Blink]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [Blink, Rectangle 2]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [Blink, Rectangle 2, Rectangle Path 1]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [Blink, Rectangle 2, Fill 1]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [Blink, Rectangle 1]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [Blink, Rectangle 1, Rectangle Path 1]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [Blink, Rectangle 1, Fill 1]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [Eyes]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [Eyes, Group 3]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [Eyes, Group 3, Fill 1]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [BeloOutlines]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [BeloOutlines, Group 1]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [BeloOutlines, Group 1, Stroke 1]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [Shirt]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [Shirt, Group 5]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [Shirt, Group 5, Fill 1]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [Body]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [Body, Group 4]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [Body, Group 4, Fill 1]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [LeftFoot]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [LeftFoot, Group 1]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [LeftFoot, Group 1, Fill 1]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [RightFoot]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [RightFoot, Group 2]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [RightFoot, Group 2, Fill 1]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [LeftArmWave]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [LeftArmWave, LeftArm]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [LeftArmWave, LeftArm, Group 6]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [LeftArmWave, LeftArm, Group 6, Fill 1]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [LeftArmWave, LeftArm, Group 5]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [LeftArmWave, LeftArm, Group 5, Fill 1]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [RightArm]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [RightArm, Group 6]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [RightArm, Group 6, Fill 1]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [RightArm, Group 5]
2020-09-10 15:30:55.762 29281-29281/com.shengj.androiddarkthemedemo D/DarkThemeDemo: [RightArm, Group 5, Fill 1]
</code></pre><p>我们抽取其中的某些形状来动态改变颜色，例如我们抽取左右手臂以及机器小人身上的T恤</p>
<div class="highlight"><pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="k">private</span> <span class="k">fun</span> <span class="nf">setupValueCallbacks</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// 机器人右手臂
</span><span class="c1"></span>        <span class="k">val</span> <span class="py">rightArm</span> <span class="p">=</span> <span class="n">KeyPath</span><span class="p">(</span><span class="s">&#34;RightArm&#34;</span><span class="p">,</span> <span class="s">&#34;Group 6&#34;</span><span class="p">,</span> <span class="s">&#34;Fill 1&#34;</span><span class="p">)</span>
        <span class="c1">// 机器人左手臂
</span><span class="c1"></span>        <span class="k">val</span> <span class="py">leftArm</span> <span class="p">=</span> <span class="n">KeyPath</span><span class="p">(</span><span class="s">&#34;LeftArmWave&#34;</span><span class="p">,</span> <span class="s">&#34;LeftArm&#34;</span><span class="p">,</span> <span class="s">&#34;Group 6&#34;</span><span class="p">,</span> <span class="s">&#34;Fill 1&#34;</span><span class="p">)</span>
        <span class="c1">// 机器人T恤
</span><span class="c1"></span>        <span class="k">val</span> <span class="py">shirt</span> <span class="p">=</span> <span class="n">KeyPath</span><span class="p">(</span><span class="s">&#34;Shirt&#34;</span><span class="p">,</span> <span class="s">&#34;Group 5&#34;</span><span class="p">,</span> <span class="s">&#34;Fill 1&#34;</span><span class="p">)</span>
        <span class="c1">// 设置右手臂颜色
</span><span class="c1"></span>        <span class="n">lottie_android_animate</span><span class="p">.</span><span class="n">addValueCallback</span><span class="p">(</span><span class="n">rightArm</span><span class="p">,</span> <span class="n">LottieProperty</span><span class="p">.</span><span class="n">COLOR</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ContextCompat</span><span class="p">.</span><span class="n">getColor</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">R</span><span class="p">.</span><span class="n">color</span><span class="p">.</span><span class="n">color_main_1</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="c1">// 设置左手臂颜色
</span><span class="c1"></span>        <span class="n">lottie_android_animate</span><span class="p">.</span><span class="n">addValueCallback</span><span class="p">(</span><span class="n">shirt</span><span class="p">,</span> <span class="n">LottieProperty</span><span class="p">.</span><span class="n">COLOR</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ContextCompat</span><span class="p">.</span><span class="n">getColor</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">R</span><span class="p">.</span><span class="n">color</span><span class="p">.</span><span class="n">color_light</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="c1">// 设置T恤颜色
</span><span class="c1"></span>        <span class="n">lottie_android_animate</span><span class="p">.</span><span class="n">addValueCallback</span><span class="p">(</span><span class="n">leftArm</span><span class="p">,</span> <span class="n">LottieProperty</span><span class="p">.</span><span class="n">COLOR</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ContextCompat</span><span class="p">.</span><span class="n">getColor</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">R</span><span class="p">.</span><span class="n">color</span><span class="p">.</span><span class="n">color_custom</span><span class="p">)</span>
        <span class="p">}</span>
  
        <span class="c1">// 播放动画描边颜色
</span><span class="c1"></span>        <span class="n">lottie_playing_animate</span><span class="p">.</span><span class="n">addValueCallback</span><span class="p">(</span><span class="n">KeyPath</span><span class="p">(</span><span class="s">&#34;**&#34;</span><span class="p">),</span> <span class="n">LottieProperty</span><span class="p">.</span><span class="n">STROKE_COLOR</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ContextCompat</span><span class="p">.</span><span class="n">getColor</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">R</span><span class="p">.</span><span class="n">color</span><span class="p">.</span><span class="n">color_text_0</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div><p>由于<code>color_main_1</code>、<code>color_light</code>以及<code>color_custom</code>都已经定义过深色模式和明亮模式的色值，因此在深色模式切换时，Lottie动画的这个机器小人的左右手臂和T恤颜色会随着深色模式切换而变化。</p>
<p>同样的对于播放动画，我们也可以设置描边颜色，来达到深色模式切换的效果。</p>
<h5 id="网络获取图片">网络获取图片</h5>
<p>对于网络获取的图片，可以让服务接口分别给出明亮模式和深色模式两套素材，然后根据上述的深色模式判断来进行切换</p>
<div class="highlight"><pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="n">Glide</span><span class="p">.</span><span class="n">with</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
  <span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="k">if</span><span class="p">(</span><span class="n">isNightMode</span><span class="p">()</span> <span class="n">nightImageUrl</span> <span class="k">else</span> <span class="n">imageUrl</span><span class="p">))</span>
  <span class="p">.</span><span class="n">into</span><span class="p">(</span><span class="n">imgView</span><span class="p">)</span>
</code></pre></div><h3 id="force-dark">Force Dark</h3>
<p>看到这里可能会有人有疑问，对于大型的项目而言，里面已经hardcore了很多的颜色值，并且很多图片都没有设计成深色模式的，那做深色模式适配是不是一个不可能完成的任务呢？答案是否定的。对于大型项目而言，除了对所有的颜色和图片定义<code>night</code>资源的自定义适配方法外，我们还可以对使用<code>Light</code>风格主题的页面进行进行<strong>强制深色模式转换</strong>。</p>
<p>我们可以分别对主题和View设置强制深色模式。对于主题，在<code>Light</code>主题中设置<code>android:forceDarkAllowed</code>，例如：</p>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;style</span> <span class="na">name=</span><span class="s">&#34;LightAppTheme&#34;</span> <span class="na">parent=</span><span class="s">&#34;Theme.MaterialComponents.Light.NoActionBar.Bridge&#34;</span><span class="nt">&gt;</span>
	<span class="ni">&amp;lt;</span>-- ... --&gt;
  <span class="nt">&lt;item</span> <span class="na">name=</span><span class="s">&#34;android:forceDarkAllowed&#34;</span><span class="nt">&gt;</span>true<span class="nt">&lt;/item&gt;</span>
<span class="nt">&lt;/style&gt;</span>
</code></pre></div><p>对于View，设置<a href="https://developer.android.com/reference/android/view/View#setForceDarkAllowed(boolean)">View.setForceDarkAllowed(boolean)</a>或者xml来设置是否支持Force Dark，默认值是true。</p>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;View</span>
  <span class="na">android:layout_width=</span><span class="s">&#34;wrap_content&#34;</span>
  <span class="na">android:layout_height=</span><span class="s">&#34;wrap_content&#34;</span>
  <span class="na">android:forceDarkAllowed=</span><span class="s">&#34;false&#34;</span><span class="nt">/&gt;</span>
</code></pre></div><p>这里需要注意的是，Force Dark的设置有以下几个规则：</p>
<ol>
<li>要强制深色模式生效必须开启硬件加速（默认开启）</li>
<li>主题设置的Force Dark仅对<code>Light</code>的主题有效，对非<code>Light</code>的主题不管是设置<code>android:forceDarkAllowed</code>为<code>true</code>或者设置<code>View.setForceDarkAllowed(true)</code>都是无效的。</li>
<li>父节点设置了不支持Force Dark，那么子节点再设置支持Force Dark无效。例如主题设置了<code>android:forceDarkAllowed</code>为<code>false</code>，则View设置<code>View.setForceDarkAllowed(true)</code>无效。同样的，如果View本身设置了支持Force Dark，但是其父layout设置了不支持，那么该View不会执行Force Dark</li>
<li>子节点设置不支持Force Dark不受父节点设置支持Force Dark影响。例如View设置了支持Force Dark，但是其子Layout设置了不支持，那么子Layout也不会执行Force Dark。</li>
</ol>
<p><em>Tips：一个比较容易记的规则就是不支持Force Dark优先，View 的 Force Dark设置一般会设置成 false，用于排除某些已经适配了深色模式的 View。</em>
下面我们从源码出发来理解Force Dark的这些行为，以及看看系统是怎么实现Force Dark的。</p>
<p><em>Tips：善用 <a href="https://cs.android.com/">https://cs.android.com/</a> 源码搜索网站可以方便查看系统源码。</em></p>
<h4 id="1-主题-1">1. 主题</h4>
<p>从主题设置的<code>forceDarkAllowed</code>入手查找，可以找到</p>
<p><strong><a href="https://cs.android.com/android/platform/superproject/+/master:frameworks/base/core/java/android/view/ViewRootImpl.java?q=forceDarkAllowed&amp;ss=android%2Fplatform%2Fsuperproject">frameworks/base/core/java/android/view/ViewRootImpl.java</a></strong></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">updateForceDarkMode</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">mAttachInfo</span><span class="o">.</span><span class="na">mThreadedRenderer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span><span class="o">;</span>
  <span class="c1">// 判断当前是否深色模式
</span><span class="c1"></span>  <span class="kt">boolean</span> <span class="n">useAutoDark</span> <span class="o">=</span> <span class="n">getNightMode</span><span class="o">()</span> <span class="o">==</span> <span class="n">Configuration</span><span class="o">.</span><span class="na">UI_MODE_NIGHT_YES</span><span class="o">;</span>
  <span class="c1">// 如果当前是深色模式
</span><span class="c1"></span>  <span class="k">if</span> <span class="o">(</span><span class="n">useAutoDark</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 获取Force Dark的系统默认值
</span><span class="c1"></span>    <span class="kt">boolean</span> <span class="n">forceDarkAllowedDefault</span> <span class="o">=</span>
      <span class="n">SystemProperties</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="n">ThreadedRenderer</span><span class="o">.</span><span class="na">DEBUG_FORCE_DARK</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
    <span class="n">TypedArray</span> <span class="n">a</span> <span class="o">=</span> <span class="n">mContext</span><span class="o">.</span><span class="na">obtainStyledAttributes</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">styleable</span><span class="o">.</span><span class="na">Theme</span><span class="o">);</span>
    <span class="c1">// 判断主题是否浅色主题 并且 判断主题设置的forceDarkAllowed
</span><span class="c1"></span>    <span class="n">useAutoDark</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">styleable</span><span class="o">.</span><span class="na">Theme_isLightTheme</span><span class="o">,</span> <span class="kc">true</span><span class="o">)</span>
      <span class="o">&amp;&amp;</span> <span class="n">a</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">styleable</span><span class="o">.</span><span class="na">Theme_forceDarkAllowed</span><span class="o">,</span> <span class="n">forceDarkAllowedDefault</span><span class="o">);</span>
    <span class="n">a</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="c1">// 将是否强制使用深色模式赋值给Renderer层
</span><span class="c1"></span>  <span class="k">if</span> <span class="o">(</span><span class="n">mAttachInfo</span><span class="o">.</span><span class="na">mThreadedRenderer</span><span class="o">.</span><span class="na">setForceDark</span><span class="o">(</span><span class="n">useAutoDark</span><span class="o">))</span> <span class="o">{</span>
    <span class="c1">// TODO: Don&#39;t require regenerating all display lists to apply this setting
</span><span class="c1"></span>    <span class="n">invalidateWorld</span><span class="o">(</span><span class="n">mView</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>而这个方法正式在<code>ViewRootImpl.enableHardwareAcceleration()</code>方法中调用的，因此可以得到第一个结论：<strong>强制深色模式只在硬件加速下生效</strong>。由于<code>userAutoDark</code>变量会判断当前主题是否为浅色，因此可以得到第二个结论：<strong>强制深色模式只在浅色主题下生效</strong>。直到这一步的调用链如下：</p>
<p><img src="https://github.com/shenguojun/ImageServer/blob/master/uPic/image-20201012103035909.png?raw=true" alt="image-20201012103035909.png"></p>
<p><code>mAttachInfo.mThreadedRenderer</code>为<code>ThreadRenderer</code>，继承自<code>HardwareRenderer</code>，指定了接下来的渲染操作由RanderThread执行。继续跟踪<code>setForceDark()</code>方法：</p>
<p><strong><a href="https://cs.android.com/android/platform/superproject/+/master:frameworks/base/graphics/java/android/graphics/HardwareRenderer.java;drc=master;l=523">frameworks/base/graphics/java/android/graphics/HardwareRenderer.java</a></strong></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">setForceDark</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">enable</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">// 如果强制深色模式变化
</span><span class="c1"></span>  <span class="k">if</span> <span class="o">(</span><span class="n">mForceDark</span> <span class="o">!=</span> <span class="n">enable</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mForceDark</span> <span class="o">=</span> <span class="n">enable</span><span class="o">;</span>
    <span class="c1">// 调用native层设置强制深色模式逻辑
</span><span class="c1"></span>    <span class="n">nSetForceDark</span><span class="o">(</span><span class="n">mNativeProxy</span><span class="o">,</span> <span class="n">enable</span><span class="o">);</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="kd">native</span> <span class="kt">void</span> <span class="nf">nSetForceDark</span><span class="o">(</span><span class="kt">long</span> <span class="n">nativeProxy</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">enabled</span><span class="o">);</span>
</code></pre></div><p>查找<code>nSetForceDark()</code>方法</p>
<p><strong><a href="https://cs.android.com/android/platform/superproject/+/master:frameworks/base/libs/hwui/jni/android_graphics_HardwareRenderer.cpp?q=nSetForceDark&amp;ss=android%2Fplatform%2Fsuperproject">frameworks/base/libs/hwui/jni/android_graphics_HardwareRenderer.cpp</a></strong></p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">static</span> <span class="k">const</span> <span class="n">JNINativeMethod</span> <span class="n">gMethods</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="c1">// ... 
</span><span class="c1"></span>    <span class="c1">// 在Android Runtime启动时，通过JNI动态注册
</span><span class="c1"></span>    <span class="p">{</span> <span class="s">&#34;nSetForceDark&#34;</span><span class="p">,</span> <span class="s">&#34;(JZ)V&#34;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_view_ThreadedRenderer_setForceDark</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&#34;preload&#34;</span><span class="p">,</span> <span class="s">&#34;()V&#34;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_view_ThreadedRenderer_preload</span> <span class="p">},</span>
<span class="p">};</span>
</code></pre></div><p>查找<code>android_view_ThreadedRenderer_setForceDark()</code>方法</p>
<p><strong><a href="https://cs.android.com/android/platform/superproject/+/master:frameworks/base/libs/hwui/jni/android_graphics_HardwareRenderer.cpp;l=586;bpv=1;bpt=1?q=android_view_ThreadedRenderer_setForceDark&amp;sq=&amp;ss=android%2Fplatform%2Fsuperproject">frameworks/base/libs/hwui/jni/android_graphics_HardwareRenderer.cpp</a></strong></p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">static</span> <span class="kt">void</span> <span class="nf">android_view_ThreadedRenderer_setForceDark</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">clazz</span><span class="p">,</span>
        <span class="n">jlong</span> <span class="n">proxyPtr</span><span class="p">,</span> <span class="n">jboolean</span> <span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">RenderProxy</span><span class="o">*</span> <span class="n">proxy</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">RenderProxy</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">proxyPtr</span><span class="p">);</span>
    <span class="c1">// 调用RenderProxy的setForceDark方法
</span><span class="c1"></span>    <span class="n">proxy</span><span class="o">-&gt;</span><span class="n">setForceDark</span><span class="p">(</span><span class="n">enable</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p><strong><a href="https://cs.android.com/android/platform/superproject/+/master:frameworks/base/libs/hwui/renderthread/RenderProxy.cpp;drc=master;bpv=1;bpt=1;l=308">frameworks/base/libs/hwui/renderthread/RenderProxy.cpp</a></strong></p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">RenderProxy</span><span class="o">::</span><span class="n">setForceDark</span><span class="p">(</span><span class="kt">bool</span> <span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="c1">// 调用CanvasContext的setForceDark方法
</span><span class="c1"></span>    <span class="n">mRenderThread</span><span class="p">.</span><span class="n">queue</span><span class="p">().</span><span class="n">post</span><span class="p">([</span><span class="k">this</span><span class="p">,</span> <span class="n">enable</span><span class="p">]()</span> <span class="p">{</span> <span class="n">mContext</span><span class="o">-&gt;</span><span class="n">setForceDark</span><span class="p">(</span><span class="n">enable</span><span class="p">);</span> <span class="p">});</span>
<span class="p">}</span>
</code></pre></div><p><strong><a href="https://cs.android.com/android/platform/superproject/+/master:frameworks/base/libs/hwui/renderthread/CanvasContext.h;drc=master;bpv=1;bpt=1;l=189">frameworks/base/libs/hwui/renderthread/CanvasContext.h</a></strong></p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// Force Dark的默认值是false
</span><span class="c1"></span><span class="kt">bool</span> <span class="n">mUseForceDark</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="c1">// 设置mUseForceDark标志
</span><span class="c1"></span><span class="kt">void</span> <span class="nf">setForceDark</span><span class="p">(</span><span class="kt">bool</span> <span class="n">enable</span><span class="p">)</span> <span class="p">{</span> <span class="n">mUseForceDark</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">bool</span> <span class="nf">useForceDark</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">mUseForceDark</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>接着查找调用<code>userForceDark()</code>方法的地方</p>
<p><strong><a href="https://cs.android.com/android/platform/superproject/+/master:frameworks/base/libs/hwui/TreeInfo.cpp;l=27;drc=master;bpv=0;bpt=1">frameworks/base/libs/hwui/TreeInfo.cpp</a></strong></p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">TreeInfo</span><span class="o">::</span><span class="n">TreeInfo</span><span class="p">(</span><span class="n">TraversalMode</span> <span class="n">mode</span><span class="p">,</span> <span class="n">renderthread</span><span class="o">::</span><span class="n">CanvasContext</span><span class="o">&amp;</span> <span class="n">canvasContext</span><span class="p">)</span>
        <span class="o">:</span> <span class="n">mode</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">prepareTextures</span><span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MODE_FULL</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">canvasContext</span><span class="p">(</span><span class="n">canvasContext</span><span class="p">)</span>
        <span class="c1">// 设置disableForceDark变量
</span><span class="c1"></span>        <span class="p">,</span> <span class="n">disableForceDark</span><span class="p">(</span><span class="n">canvasContext</span><span class="p">.</span><span class="n">useForceDark</span><span class="p">()</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">,</span> <span class="n">screenSize</span><span class="p">(</span><span class="n">canvasContext</span><span class="p">.</span><span class="n">getNextFrameSize</span><span class="p">())</span> <span class="p">{}</span>

<span class="p">}</span>  <span class="c1">// namespace android::uirenderer
</span></code></pre></div><p><strong><a href="https://cs.android.com/android/platform/superproject/+/master:frameworks/base/libs/hwui/TreeInfo.h;drc=master;bpv=0;bpt=1;l=97">frameworks/base/libs/hwui/TreeInfo.h</a></strong></p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">TreeInfo</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="c1">// ...
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">disableForceDark</span><span class="p">;</span>
    <span class="c1">// ...
</span><span class="c1"></span><span class="p">};</span>
</code></pre></div><p>到了这里，可以看出，当设置了Force Dark之后，最终会设置到<code>TreeInfo</code>类中的<code>disableForceDark</code>变量，如果没有设置主题的Force Dark，那么根据false的默认值，<code>disableForceDark</code>变量会别设置成1，如果设置了使用强制深色模式，那么<code>disableForceDark</code>会变成0。</p>
<p>这个变量最终会用在RenderNode的<code>RenderNode.handleForceDark()</code>过程中，到达的流程如下图：</p>
<p><img src="https://github.com/shenguojun/ImageServer/blob/master/uPic/image-20201012103247032.png?raw=true" alt="image-20201012103247032.png"></p>
<p><strong><a href="https://cs.android.com/android/platform/superproject/+/master:frameworks/base/libs/hwui/RenderNode.cpp;l=235;drc=master;bpv=0;bpt=1">frameworks/base/libs/hwui/RenderNode.cpp</a></strong></p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="kt">void</span> <span class="n">RenderNode</span><span class="o">::</span><span class="n">prepareTreeImpl</span><span class="p">(</span><span class="n">TreeObserver</span><span class="o">&amp;</span> <span class="n">observer</span><span class="p">,</span> <span class="n">TreeInfo</span><span class="o">&amp;</span> <span class="n">info</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">functorsNeedLayer</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span>    <span class="c1">// 同步正在处理的RenderNode Property变化
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">TreeInfo</span><span class="o">::</span><span class="n">MODE_FULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pushStagingPropertiesChanges</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// 如果当前View不允许被ForceDark，那么info.disableForceDark值+1
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mProperties</span><span class="p">.</span><span class="n">getAllowForceDark</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">info</span><span class="p">.</span><span class="n">disableForceDark</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// ...
</span><span class="c1"></span>    <span class="c1">// 同步正在处理的Render Node的Display List，实现具体深色的逻辑
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">TreeInfo</span><span class="o">::</span><span class="n">MODE_FULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pushStagingDisplayListChanges</span><span class="p">(</span><span class="n">observer</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">mDisplayList</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">info</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">hasFunctors</span> <span class="o">|=</span> <span class="n">mDisplayList</span><span class="o">-&gt;</span><span class="n">hasFunctor</span><span class="p">();</span>
        <span class="kt">bool</span> <span class="n">isDirty</span> <span class="o">=</span> <span class="n">mDisplayList</span><span class="o">-&gt;</span><span class="n">prepareListAndChildren</span><span class="p">(</span>
                <span class="n">observer</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">childFunctorsNeedLayer</span><span class="p">,</span>
                <span class="p">[](</span><span class="n">RenderNode</span><span class="o">*</span> <span class="n">child</span><span class="p">,</span> <span class="n">TreeObserver</span><span class="o">&amp;</span> <span class="n">observer</span><span class="p">,</span> <span class="n">TreeInfo</span><span class="o">&amp;</span> <span class="n">info</span><span class="p">,</span>
                   <span class="kt">bool</span> <span class="n">functorsNeedLayer</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">// 递归调用子节点的prepareTreeImpl。
</span><span class="c1"></span>                    <span class="c1">// 递归调用之前，若父节点不允许强制深色模式，disableForceDark已经不为0，
</span><span class="c1"></span>                    <span class="c1">//     子节点再设置允许强制深色模式不会使得disableForceDark的值减少，
</span><span class="c1"></span>                    <span class="c1">//     因此有第三个规则：父节点设置了不允许深色模式，子节点再设置允许深色模式无效。
</span><span class="c1"></span>                    <span class="c1">// 同样的，递归调用之前，若父节点允许深色模式，disableForceDark为0，
</span><span class="c1"></span>                    <span class="c1">//     子节点再设置不允许强制深色模式，则disableForceDark值还是会++，不为0
</span><span class="c1"></span>                    <span class="c1">//     因此有第四个规则：子节点设置不允许强制深色模式不受父节点设置允许强制深色模式影响。
</span><span class="c1"></span>                    <span class="n">child</span><span class="o">-&gt;</span><span class="n">prepareTreeImpl</span><span class="p">(</span><span class="n">observer</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">functorsNeedLayer</span><span class="p">);</span>
                <span class="p">});</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">isDirty</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">damageSelf</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">pushLayerUpdate</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
    <span class="c1">// 递归结束后将之前设置过+1的值做回退-1恢复操作，避免影响其他兄弟结点的深色模式值判断
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mProperties</span><span class="p">.</span><span class="n">getAllowForceDark</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">info</span><span class="p">.</span><span class="n">disableForceDark</span><span class="o">--</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">info</span><span class="p">.</span><span class="n">damageAccumulator</span><span class="o">-&gt;</span><span class="n">popTransform</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">RenderNode</span><span class="o">::</span><span class="n">pushStagingDisplayListChanges</span><span class="p">(</span><span class="n">TreeObserver</span><span class="o">&amp;</span> <span class="n">observer</span><span class="p">,</span> <span class="n">TreeInfo</span><span class="o">&amp;</span> <span class="n">info</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span>    <span class="c1">// 同步DisplayList
</span><span class="c1"></span>    <span class="n">syncDisplayList</span><span class="p">(</span><span class="n">observer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
    <span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span>

<span class="kt">void</span> <span class="n">RenderNode</span><span class="o">::</span><span class="n">syncDisplayList</span><span class="p">(</span><span class="n">TreeObserver</span><span class="o">&amp;</span> <span class="n">observer</span><span class="p">,</span> <span class="n">TreeInfo</span><span class="o">*</span> <span class="n">info</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">mDisplayList</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">WebViewSyncData</span> <span class="n">syncData</span> <span class="p">{</span>
            <span class="c1">// 设置WebViewSyncData的applyForceDark
</span><span class="c1"></span>            <span class="p">.</span><span class="n">applyForceDark</span> <span class="o">=</span> <span class="n">info</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">disableForceDark</span>
        <span class="p">};</span>
        <span class="n">mDisplayList</span><span class="o">-&gt;</span><span class="n">syncContents</span><span class="p">(</span><span class="n">syncData</span><span class="p">);</span>
        <span class="c1">// 强制执行深色模式执行
</span><span class="c1"></span>        <span class="n">handleForceDark</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">RenderNode</span><span class="o">::</span><span class="n">handleForceDark</span><span class="p">(</span><span class="n">android</span><span class="o">::</span><span class="n">uirenderer</span><span class="o">::</span><span class="n">TreeInfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">CC_LIKELY</span><span class="p">(</span><span class="o">!</span><span class="n">info</span> <span class="o">||</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">disableForceDark</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">// 如果disableForceDark不为0，关闭强制深色模式，则直接返回
</span><span class="c1"></span>        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">auto</span> <span class="n">usage</span> <span class="o">=</span> <span class="n">usageHint</span><span class="p">();</span>
    <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">children</span> <span class="o">=</span> <span class="n">mDisplayList</span><span class="o">-&gt;</span><span class="n">mChildNodes</span><span class="p">;</span>
    <span class="c1">// 如果有文字表示是前景策略
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">mDisplayList</span><span class="o">-&gt;</span><span class="n">hasText</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">usage</span> <span class="o">=</span> <span class="n">UsageHint</span><span class="o">::</span><span class="n">Foreground</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">usage</span> <span class="o">==</span> <span class="n">UsageHint</span><span class="o">::</span><span class="n">Unknown</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 如果子节点大于1或者第一个子节点不是背景，那么设置为背景策略
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">children</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">usage</span> <span class="o">=</span> <span class="n">UsageHint</span><span class="o">::</span><span class="n">Background</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">children</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
                <span class="n">children</span><span class="p">.</span><span class="n">front</span><span class="p">().</span><span class="n">getRenderNode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">usageHint</span><span class="p">()</span> <span class="o">!=</span>
                        <span class="n">UsageHint</span><span class="o">::</span><span class="n">Background</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">usage</span> <span class="o">=</span> <span class="n">UsageHint</span><span class="o">::</span><span class="n">Background</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">children</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Crude overlap check
</span><span class="c1"></span>        <span class="n">SkRect</span> <span class="n">drawn</span> <span class="o">=</span> <span class="n">SkRect</span><span class="o">::</span><span class="n">MakeEmpty</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">children</span><span class="p">.</span><span class="n">rbegin</span><span class="p">();</span> <span class="n">iter</span> <span class="o">!=</span> <span class="n">children</span><span class="p">.</span><span class="n">rend</span><span class="p">();</span> <span class="o">++</span><span class="n">iter</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">child</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">getRenderNode</span><span class="p">();</span>
            <span class="c1">// We use stagingProperties here because we haven&#39;t yet sync&#39;d the children
</span><span class="c1"></span>            <span class="n">SkRect</span> <span class="n">bounds</span> <span class="o">=</span> <span class="n">SkRect</span><span class="o">::</span><span class="n">MakeXYWH</span><span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">stagingProperties</span><span class="p">().</span><span class="n">getX</span><span class="p">(),</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">stagingProperties</span><span class="p">().</span><span class="n">getY</span><span class="p">(),</span>
                    <span class="n">child</span><span class="o">-&gt;</span><span class="n">stagingProperties</span><span class="p">().</span><span class="n">getWidth</span><span class="p">(),</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">stagingProperties</span><span class="p">().</span><span class="n">getHeight</span><span class="p">());</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">bounds</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">drawn</span><span class="p">))</span> <span class="p">{</span>
                <span class="c1">// This contains everything drawn after it, so make it a background
</span><span class="c1"></span>                <span class="n">child</span><span class="o">-&gt;</span><span class="n">setUsageHint</span><span class="p">(</span><span class="n">UsageHint</span><span class="o">::</span><span class="n">Background</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">drawn</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">bounds</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// 根据前景还是背景策略对颜色进行提亮或者加深
</span><span class="c1"></span>    <span class="n">mDisplayList</span><span class="o">-&gt;</span><span class="n">mDisplayList</span><span class="p">.</span><span class="n">applyColorTransform</span><span class="p">(</span>
            <span class="n">usage</span> <span class="o">==</span> <span class="n">UsageHint</span><span class="o">::</span><span class="n">Background</span> <span class="o">?</span> <span class="n">ColorTransform</span><span class="o">::</span><span class="nl">Dark</span> <span class="p">:</span> <span class="n">ColorTransform</span><span class="o">::</span><span class="n">Light</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p><em>Tips：View的绘制会根据VSYNC信号，将UI线程的Display List树同步到Render线程的Display List树，并通过生产者消费者模式将layout信息放置到SurfaceFlinger中，并最后交给Haredware Composer进行合成绘制。具体View渲染逻辑见参考章节的15~19文章列表。</em></p>
<p><strong><a href="https://cs.android.com/android/platform/superproject/+/master:frameworks/base/libs/hwui/RecordingCanvas.cpp;l=800;drc=master">frameworks/base/libs/hwui/RecordingCanvas.cpp</a></strong></p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">DisplayListData</span><span class="o">::</span><span class="n">applyColorTransform</span><span class="p">(</span><span class="n">ColorTransform</span> <span class="n">transform</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 使用transform作为参数执行color_transform_fns函数组
</span><span class="c1"></span>    <span class="k">this</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">(</span><span class="n">color_transform_fns</span><span class="p">,</span> <span class="n">transform</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Fn</span><span class="p">,</span> <span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
<span class="kr">inline</span> <span class="kt">void</span> <span class="n">DisplayListData</span><span class="o">::</span><span class="n">map</span><span class="p">(</span><span class="k">const</span> <span class="n">Fn</span> <span class="n">fns</span><span class="p">[],</span> <span class="n">Args</span><span class="p">...</span> <span class="n">args</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">end</span> <span class="o">=</span> <span class="n">fBytes</span><span class="p">.</span><span class="n">get</span><span class="p">()</span> <span class="o">+</span> <span class="n">fUsed</span><span class="p">;</span>
    <span class="c1">// 遍历需要绘制的元素op，并调用对应类型的colorTransformForOp函数
</span><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">fBytes</span><span class="p">.</span><span class="n">get</span><span class="p">();</span> <span class="n">ptr</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;)</span> <span class="p">{</span>
        <span class="k">auto</span> <span class="n">op</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">Op</span><span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>
        <span class="k">auto</span> <span class="n">type</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
        <span class="k">auto</span> <span class="n">skip</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">skip</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">auto</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">fns</span><span class="p">[</span><span class="n">type</span><span class="p">])</span> <span class="p">{</span>  <span class="c1">// We replace no-op functions with nullptrs
</span><span class="c1"></span>            <span class="n">fn</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">args</span><span class="p">...);</span>        <span class="c1">// to avoid the overhead of a pointless call.
</span><span class="c1"></span>        <span class="p">}</span>
        <span class="n">ptr</span> <span class="o">+=</span> <span class="n">skip</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">typedef</span> <span class="nf">void</span> <span class="p">(</span><span class="o">*</span><span class="n">color_transform_fn</span><span class="p">)(</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span><span class="p">,</span> <span class="n">ColorTransform</span><span class="p">);</span>

<span class="cp">#define X(T) colorTransformForOp&lt;T&gt;(),
</span><span class="cp"></span><span class="k">static</span> <span class="k">const</span> <span class="n">color_transform_fn</span> <span class="n">color_transform_fns</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// 相当于 colorTransformForOp&lt;Flush&gt;()
</span><span class="c1"></span>  <span class="n">X</span><span class="p">(</span><span class="n">Flush</span><span class="p">)</span>
  <span class="n">X</span><span class="p">(</span><span class="n">Save</span><span class="p">)</span>
  <span class="n">X</span><span class="p">(</span><span class="n">Restore</span><span class="p">)</span>
  <span class="n">X</span><span class="p">(</span><span class="n">SaveLayer</span><span class="p">)</span>
  <span class="n">X</span><span class="p">(</span><span class="n">SaveBehind</span><span class="p">)</span>
  <span class="n">X</span><span class="p">(</span><span class="n">Concat44</span><span class="p">)</span>
  <span class="n">X</span><span class="p">(</span><span class="n">Concat</span><span class="p">)</span>
  <span class="n">X</span><span class="p">(</span><span class="n">SetMatrix</span><span class="p">)</span>
  <span class="n">X</span><span class="p">(</span><span class="n">Scale</span><span class="p">)</span>
  <span class="n">X</span><span class="p">(</span><span class="n">Translate</span><span class="p">)</span>
  <span class="n">X</span><span class="p">(</span><span class="n">ClipPath</span><span class="p">)</span>
  <span class="n">X</span><span class="p">(</span><span class="n">ClipRect</span><span class="p">)</span>
  <span class="n">X</span><span class="p">(</span><span class="n">ClipRRect</span><span class="p">)</span>
  <span class="n">X</span><span class="p">(</span><span class="n">ClipRegion</span><span class="p">)</span>
  <span class="n">X</span><span class="p">(</span><span class="n">DrawPaint</span><span class="p">)</span>
  <span class="n">X</span><span class="p">(</span><span class="n">DrawBehind</span><span class="p">)</span>
  <span class="n">X</span><span class="p">(</span><span class="n">DrawPath</span><span class="p">)</span>
  <span class="n">X</span><span class="p">(</span><span class="n">DrawRect</span><span class="p">)</span>
  <span class="n">X</span><span class="p">(</span><span class="n">DrawRegion</span><span class="p">)</span>
  <span class="n">X</span><span class="p">(</span><span class="n">DrawOval</span><span class="p">)</span>
  <span class="n">X</span><span class="p">(</span><span class="n">DrawArc</span><span class="p">)</span>
  <span class="n">X</span><span class="p">(</span><span class="n">DrawRRect</span><span class="p">)</span>
  <span class="n">X</span><span class="p">(</span><span class="n">DrawDRRect</span><span class="p">)</span>
  <span class="n">X</span><span class="p">(</span><span class="n">DrawAnnotation</span><span class="p">)</span>
  <span class="n">X</span><span class="p">(</span><span class="n">DrawDrawable</span><span class="p">)</span>
  <span class="n">X</span><span class="p">(</span><span class="n">DrawPicture</span><span class="p">)</span>
  <span class="n">X</span><span class="p">(</span><span class="n">DrawImage</span><span class="p">)</span>
  <span class="n">X</span><span class="p">(</span><span class="n">DrawImageNine</span><span class="p">)</span>
  <span class="n">X</span><span class="p">(</span><span class="n">DrawImageRect</span><span class="p">)</span>
  <span class="n">X</span><span class="p">(</span><span class="n">DrawImageLattice</span><span class="p">)</span>
  <span class="n">X</span><span class="p">(</span><span class="n">DrawTextBlob</span><span class="p">)</span>
  <span class="n">X</span><span class="p">(</span><span class="n">DrawPatch</span><span class="p">)</span>
  <span class="n">X</span><span class="p">(</span><span class="n">DrawPoints</span><span class="p">)</span>
  <span class="n">X</span><span class="p">(</span><span class="n">DrawVertices</span><span class="p">)</span>
  <span class="n">X</span><span class="p">(</span><span class="n">DrawAtlas</span><span class="p">)</span>
  <span class="n">X</span><span class="p">(</span><span class="n">DrawShadowRec</span><span class="p">)</span>
  <span class="n">X</span><span class="p">(</span><span class="n">DrawVectorDrawable</span><span class="p">)</span>
  <span class="n">X</span><span class="p">(</span><span class="n">DrawWebView</span><span class="p">)</span>
<span class="p">};</span>
<span class="cp">#undef X
</span><span class="cp"></span>
<span class="k">struct</span> <span class="nc">DrawImage</span> <span class="k">final</span> <span class="o">:</span> <span class="n">Op</span> <span class="p">{</span>
    <span class="k">static</span> <span class="k">const</span> <span class="k">auto</span> <span class="n">kType</span> <span class="o">=</span> <span class="n">Type</span><span class="o">::</span><span class="n">DrawImage</span><span class="p">;</span>
    <span class="n">DrawImage</span><span class="p">(</span><span class="n">sk_sp</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">SkImage</span><span class="o">&gt;&amp;&amp;</span> <span class="n">image</span><span class="p">,</span> <span class="n">SkScalar</span> <span class="n">x</span><span class="p">,</span> <span class="n">SkScalar</span> <span class="n">y</span><span class="p">,</span> <span class="k">const</span> <span class="n">SkPaint</span><span class="o">*</span> <span class="n">paint</span><span class="p">,</span>
              <span class="n">BitmapPalette</span> <span class="n">palette</span><span class="p">)</span>
            <span class="o">:</span> <span class="n">image</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">image</span><span class="p">)),</span> <span class="n">x</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">y</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">palette</span><span class="p">(</span><span class="n">palette</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">paint</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="o">-&gt;</span><span class="n">paint</span> <span class="o">=</span> <span class="o">*</span><span class="n">paint</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">sk_sp</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">SkImage</span><span class="o">&gt;</span> <span class="n">image</span><span class="p">;</span>
    <span class="n">SkScalar</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
    <span class="c1">// 这里SK指代skia库对象
</span><span class="c1"></span>    <span class="n">SkPaint</span> <span class="n">paint</span><span class="p">;</span>
    <span class="n">BitmapPalette</span> <span class="n">palette</span><span class="p">;</span>
    <span class="kt">void</span> <span class="nf">draw</span><span class="p">(</span><span class="n">SkCanvas</span><span class="o">*</span> <span class="n">c</span><span class="p">,</span> <span class="k">const</span> <span class="n">SkMatrix</span><span class="o">&amp;</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">drawImage</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">paint</span><span class="p">);</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="k">constexpr</span> <span class="n">color_transform_fn</span> <span class="n">colorTransformForOp</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span>
        <span class="c1">// 如果类型T有paint变量，并且有palette变量
</span><span class="c1"></span>        <span class="k">constexpr</span><span class="p">(</span><span class="n">has_paint</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&amp;&amp;</span> <span class="n">has_palette</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// It&#39;s a bitmap(绘制Bitmap)
</span><span class="c1"></span>            <span class="c1">// 例如对于一个DrawImage的OP，最终会调用到这里
</span><span class="c1"></span>            <span class="c1">// opRaw对应DrawImage对象，transform为ColorTransform::Dark或者ColorTransform::Light
</span><span class="c1"></span>            <span class="k">return</span> <span class="p">[](</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">opRaw</span><span class="p">,</span> <span class="n">ColorTransform</span> <span class="n">transform</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// TODO: We should be const. Or not. Or just use a different map
</span><span class="c1"></span>                <span class="c1">// Unclear, but this is the quick fix
</span><span class="c1"></span>                <span class="k">const</span> <span class="n">T</span><span class="o">*</span> <span class="n">op</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">T</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">opRaw</span><span class="p">);</span>
                <span class="n">transformPaint</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">SkPaint</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">paint</span><span class="p">)),</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">);</span>
            <span class="p">};</span>
        <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span>
        <span class="nf">constexpr</span><span class="p">(</span><span class="n">has_paint</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">[](</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">opRaw</span><span class="p">,</span> <span class="n">ColorTransform</span> <span class="n">transform</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// TODO: We should be const. Or not. Or just use a different map
</span><span class="c1"></span>                <span class="c1">// Unclear, but this is the quick fix
</span><span class="c1"></span>                <span class="c1">// 非Bitmap绘制
</span><span class="c1"></span>                <span class="k">const</span> <span class="n">T</span><span class="o">*</span> <span class="n">op</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">T</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">opRaw</span><span class="p">);</span>
                <span class="n">transformPaint</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">SkPaint</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">paint</span><span class="p">)));</span>
            <span class="p">};</span>
        <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p><strong><a href="https://cs.android.com/android/platform/superproject/+/master:frameworks/base/libs/hwui/CanvasTransform.cpp;drc=master;bpv=1;bpt=1;l=132">frameworks/base/libs/hwui/CanvasTransform.cpp</a></strong></p>
<p>这里进行具体的颜色转换逻辑，我们首先关注非Bitmap绘制的颜色转换</p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// 非Bitmap绘制颜色模式转换
</span><span class="c1"></span><span class="kt">bool</span> <span class="nf">transformPaint</span><span class="p">(</span><span class="n">ColorTransform</span> <span class="n">transform</span><span class="p">,</span> <span class="n">SkPaint</span><span class="o">*</span> <span class="n">paint</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">applyColorTransform</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="o">*</span><span class="n">paint</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// 非Bitmap绘制颜色模式转换
</span><span class="c1"></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">applyColorTransform</span><span class="p">(</span><span class="n">ColorTransform</span> <span class="n">transform</span><span class="p">,</span> <span class="n">SkPaint</span><span class="o">&amp;</span> <span class="n">paint</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">transform</span> <span class="o">==</span> <span class="n">ColorTransform</span><span class="o">::</span><span class="n">None</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="c1">// 具体绘制颜色转换逻辑
</span><span class="c1"></span>    <span class="n">SkColor</span> <span class="n">newColor</span> <span class="o">=</span> <span class="n">transformColor</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="n">paint</span><span class="p">.</span><span class="n">getColor</span><span class="p">());</span>
    <span class="c1">// 将画笔颜色修改为转换后的颜色
</span><span class="c1"></span>    <span class="n">paint</span><span class="p">.</span><span class="n">setColor</span><span class="p">(</span><span class="n">newColor</span><span class="p">);</span>

    <span class="c1">// 有渐变色情况
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">paint</span><span class="p">.</span><span class="n">getShader</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">SkShader</span><span class="o">::</span><span class="n">GradientInfo</span> <span class="n">info</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">SkColor</span><span class="p">,</span> <span class="mi">10</span><span class="o">&gt;</span> <span class="n">_colorStorage</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">SkScalar</span><span class="p">,</span> <span class="n">_colorStorage</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">&gt;</span> <span class="n">_offsetStorage</span><span class="p">;</span>
        <span class="n">info</span><span class="p">.</span><span class="n">fColorCount</span> <span class="o">=</span> <span class="n">_colorStorage</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
        <span class="n">info</span><span class="p">.</span><span class="n">fColors</span> <span class="o">=</span> <span class="n">_colorStorage</span><span class="p">.</span><span class="n">data</span><span class="p">();</span>
        <span class="n">info</span><span class="p">.</span><span class="n">fColorOffsets</span> <span class="o">=</span> <span class="n">_offsetStorage</span><span class="p">.</span><span class="n">data</span><span class="p">();</span>
        <span class="n">SkShader</span><span class="o">::</span><span class="n">GradientType</span> <span class="n">type</span> <span class="o">=</span> <span class="n">paint</span><span class="p">.</span><span class="n">getShader</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">asAGradient</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">fColorCount</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// 线性渐变并且渐变颜色少于等于10个的情况
</span><span class="c1"></span>                <span class="k">case</span> <span class="n">SkShader</span><span class="o">::</span><span class="nl">kLinear_GradientType</span><span class="p">:</span>
                    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="p">.</span><span class="n">fColorCount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                        <span class="c1">// 对渐变色颜色进行转换
</span><span class="c1"></span>                        <span class="n">info</span><span class="p">.</span><span class="n">fColors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">transformColor</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">fColors</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
                    <span class="p">}</span>
                    <span class="n">paint</span><span class="p">.</span><span class="n">setShader</span><span class="p">(</span><span class="n">SkGradientShader</span><span class="o">::</span><span class="n">MakeLinear</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">fPoint</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">fColors</span><span class="p">,</span>
                                                                 <span class="n">info</span><span class="p">.</span><span class="n">fColorOffsets</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">fColorCount</span><span class="p">,</span>
                                                                 <span class="n">info</span><span class="p">.</span><span class="n">fTileMode</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">fGradientFlags</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">));</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">default</span><span class="o">:</span><span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>

        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// 处理colorFilter
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">paint</span><span class="p">.</span><span class="n">getColorFilter</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">SkBlendMode</span> <span class="n">mode</span><span class="p">;</span>
        <span class="n">SkColor</span> <span class="n">color</span><span class="p">;</span>
        <span class="c1">// TODO: LRU this or something to avoid spamming new color mode filters
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">paint</span><span class="p">.</span><span class="n">getColorFilter</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">asAColorMode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">color</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// 对colorFilter颜色进行转换
</span><span class="c1"></span>            <span class="n">color</span> <span class="o">=</span> <span class="n">transformColor</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="n">color</span><span class="p">);</span>
            <span class="n">paint</span><span class="p">.</span><span class="n">setColorFilter</span><span class="p">(</span><span class="n">SkColorFilters</span><span class="o">::</span><span class="n">Blend</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">mode</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SkColor</span> <span class="nf">transformColor</span><span class="p">(</span><span class="n">ColorTransform</span> <span class="n">transform</span><span class="p">,</span> <span class="n">SkColor</span> <span class="n">color</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">transform</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">ColorTransform</span><span class="o">::</span><span class="nl">Light</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">makeLight</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
        <span class="k">case</span> <span class="n">ColorTransform</span><span class="o">::</span><span class="nl">Dark</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">makeDark</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
        <span class="k">default</span><span class="o">:</span>
            <span class="k">return</span> <span class="n">color</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 前景色变亮
</span><span class="c1"></span><span class="k">static</span> <span class="n">SkColor</span> <span class="nf">makeLight</span><span class="p">(</span><span class="n">SkColor</span> <span class="n">color</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 将sRGB色彩模式转换成Lab色彩模式
</span><span class="c1"></span>    <span class="n">Lab</span> <span class="n">lab</span> <span class="o">=</span> <span class="n">sRGBToLab</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="c1">// 对亮度L维度取反
</span><span class="c1"></span>    <span class="kt">float</span> <span class="n">invertedL</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="mi">110</span> <span class="o">-</span> <span class="n">lab</span><span class="p">.</span><span class="n">L</span><span class="p">,</span> <span class="mf">100.0f</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">invertedL</span> <span class="o">&gt;</span> <span class="n">lab</span><span class="p">.</span><span class="n">L</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 若取反后亮度变亮，则替换原来亮度
</span><span class="c1"></span>        <span class="n">lab</span><span class="p">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">invertedL</span><span class="p">;</span>
        <span class="c1">// 重新转换为sRGB模式
</span><span class="c1"></span>        <span class="k">return</span> <span class="n">LabToSRGB</span><span class="p">(</span><span class="n">lab</span><span class="p">,</span> <span class="n">SkColorGetA</span><span class="p">(</span><span class="n">color</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">color</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 后景色变暗
</span><span class="c1"></span><span class="k">static</span> <span class="n">SkColor</span> <span class="nf">makeDark</span><span class="p">(</span><span class="n">SkColor</span> <span class="n">color</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 将sRGB色彩模式转换成Lab色彩模式
</span><span class="c1"></span>    <span class="n">Lab</span> <span class="n">lab</span> <span class="o">=</span> <span class="n">sRGBToLab</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="c1">// 对亮度L维度取反
</span><span class="c1"></span>    <span class="kt">float</span> <span class="n">invertedL</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="mi">110</span> <span class="o">-</span> <span class="n">lab</span><span class="p">.</span><span class="n">L</span><span class="p">,</span> <span class="mf">100.0f</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">invertedL</span> <span class="o">&lt;</span> <span class="n">lab</span><span class="p">.</span><span class="n">L</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 若取反后亮度变暗，则替换原来亮度
</span><span class="c1"></span>        <span class="n">lab</span><span class="p">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">invertedL</span><span class="p">;</span>
        <span class="c1">// 重新转换为sRGB模式
</span><span class="c1"></span>        <span class="k">return</span> <span class="n">LabToSRGB</span><span class="p">(</span><span class="n">lab</span><span class="p">,</span> <span class="n">SkColorGetA</span><span class="p">(</span><span class="n">color</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">color</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>从代码中可以看出，深色模式应用之后，通过对sRGB色彩空间转换<a href="https://zh.wikipedia.org/wiki/Lab%E8%89%B2%E5%BD%A9%E7%A9%BA%E9%97%B4">Lab色彩空间</a>，并对表示亮度的维度L进行取反，并判断取反后前景色是不是更亮，后景色是不是更暗，若是的话就替换为原来的L，并再重新转换为sRGB色彩空间，从而实现反色的效果。</p>
<p>我们再来看对图片的强制深色模式处理：</p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// Bitmap绘制颜色模式转换
</span><span class="c1"></span><span class="kt">bool</span> <span class="nf">transformPaint</span><span class="p">(</span><span class="n">ColorTransform</span> <span class="n">transform</span><span class="p">,</span> <span class="n">SkPaint</span><span class="o">*</span> <span class="n">paint</span><span class="p">,</span> <span class="n">BitmapPalette</span> <span class="n">palette</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 考虑加上filter之后图片的明暗
</span><span class="c1"></span>    <span class="n">palette</span> <span class="o">=</span> <span class="n">filterPalette</span><span class="p">(</span><span class="n">paint</span><span class="p">,</span> <span class="n">palette</span><span class="p">);</span>
    <span class="kt">bool</span> <span class="n">shouldInvert</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">palette</span> <span class="o">==</span> <span class="n">BitmapPalette</span><span class="o">::</span><span class="n">Light</span> <span class="o">&amp;&amp;</span> <span class="n">transform</span> <span class="o">==</span> <span class="n">ColorTransform</span><span class="o">::</span><span class="n">Dark</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 图片比较亮但是需要变暗
</span><span class="c1"></span>        <span class="n">shouldInvert</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">palette</span> <span class="o">==</span> <span class="n">BitmapPalette</span><span class="o">::</span><span class="n">Dark</span> <span class="o">&amp;&amp;</span> <span class="n">transform</span> <span class="o">==</span> <span class="n">ColorTransform</span><span class="o">::</span><span class="n">Light</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 图片比较暗但是需要变亮
</span><span class="c1"></span>        <span class="n">shouldInvert</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">shouldInvert</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">SkHighContrastConfig</span> <span class="n">config</span><span class="p">;</span>
        <span class="c1">// 设置skia反转亮度的filter
</span><span class="c1"></span>        <span class="n">config</span><span class="p">.</span><span class="n">fInvertStyle</span> <span class="o">=</span> <span class="n">SkHighContrastConfig</span><span class="o">::</span><span class="n">InvertStyle</span><span class="o">::</span><span class="n">kInvertLightness</span><span class="p">;</span>
        <span class="n">paint</span><span class="o">-&gt;</span><span class="n">setColorFilter</span><span class="p">(</span><span class="n">SkHighContrastFilter</span><span class="o">::</span><span class="n">Make</span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">makeComposed</span><span class="p">(</span><span class="n">paint</span><span class="o">-&gt;</span><span class="n">refColorFilter</span><span class="p">()));</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">shouldInvert</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// 获取paint filter的palette值，若没有filter直接返回原来的palette
</span><span class="c1"></span><span class="k">static</span> <span class="n">BitmapPalette</span> <span class="nf">filterPalette</span><span class="p">(</span><span class="k">const</span> <span class="n">SkPaint</span><span class="o">*</span> <span class="n">paint</span><span class="p">,</span> <span class="n">BitmapPalette</span> <span class="n">palette</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 如果没有filter color返回原来的palette
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">palette</span> <span class="o">==</span> <span class="n">BitmapPalette</span><span class="o">::</span><span class="n">Unknown</span> <span class="o">||</span> <span class="o">!</span><span class="n">paint</span> <span class="o">||</span> <span class="o">!</span><span class="n">paint</span><span class="o">-&gt;</span><span class="n">getColorFilter</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">palette</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">SkColor</span> <span class="n">color</span> <span class="o">=</span> <span class="n">palette</span> <span class="o">==</span> <span class="n">BitmapPalette</span><span class="o">::</span><span class="n">Light</span> <span class="o">?</span> <span class="nl">SK_ColorWHITE</span> <span class="p">:</span> <span class="n">SK_ColorBLACK</span><span class="p">;</span>
    <span class="c1">// 获取filter color，并根据palette的明暗再叠加一层白色或者黑色
</span><span class="c1"></span>    <span class="n">color</span> <span class="o">=</span> <span class="n">paint</span><span class="o">-&gt;</span><span class="n">getColorFilter</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">filterColor</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
    <span class="c1">// 根据将颜色转换为HSV空间，并返回是图片的亮度是亮还是暗
</span><span class="c1"></span>    <span class="k">return</span> <span class="n">paletteForColorHSV</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p>从代码中可以看出，对于Bitmap类型的绘制，先判断原来绘制Bitmap的明暗度，如果原来绘制的图像较为明亮但是需要变暗，或者原来绘制的图像较为暗需要变明亮，则设置一个明亮度转换的filter到画笔paint中。</p>
<p>至此，对于主题级别的强制深色转换原理已经非常清晰。<strong>总结一下，就是需要对前景色变亮和背景色变暗，然后对于非Bitmap类型明暗变化采用的是将色值转换为Lab颜色空间进行明亮度转换，对于Bitmap类型的明暗变化采取设置亮度转换的filter进行。</strong></p>
<h4 id="2-view">2. View</h4>
<p>无论是设置View的xml的<code>android:forceDarkAllowed</code>属性，还是调用<code>View.setForceDarkAllowed()</code>最后还是调用到<a href="https://cs.android.com/android/platform/superproject/+/master:frameworks/base/core/java/android/view/View.java?q=setForceDarkAllowed">frameworks/base/core/java/android/view/View.java</a>的<code>mRenderNode.setForceDarkAllowed()</code>方法。</p>
<p><strong><a href="https://cs.android.com/android/platform/superproject/+/master:frameworks/base/graphics/java/android/graphics/RenderNode.java;drc=master;l=1414">frameworks/base/graphics/java/android/graphics/RenderNode.java</a></strong></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">setForceDarkAllowed</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">allow</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">nSetAllowForceDark</span><span class="o">(</span><span class="n">mNativeRenderNode</span><span class="o">,</span> <span class="n">allow</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><p><code>nSetAllowForceDark</code>通过JNI调用到<code>android_view_RenderNode_setAllowForceDark</code>Navtive方法中。</p>
<p><strong><a href="https://cs.android.com/android/platform/superproject/+/master:frameworks/base/libs/hwui/jni/android_graphics_RenderNode.cpp;l=744?q=nSetAllowForceDark&amp;ss=android%2Fplatform%2Fsuperproject">frameworks/base/libs/hwui/jni/android_graphics_RenderNode.cpp</a></strong></p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">static</span> <span class="k">const</span> <span class="n">JNINativeMethod</span> <span class="n">gMethods</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// ...
</span><span class="c1"></span>  <span class="p">{</span> <span class="s">&#34;nSetAllowForceDark&#34;</span><span class="p">,</span>        <span class="s">&#34;(JZ)Z&#34;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="n">android_view_RenderNode_setAllowForceDark</span> <span class="p">},</span>
  <span class="c1">// ...
</span><span class="c1"></span><span class="p">};</span>

<span class="k">static</span> <span class="n">jboolean</span> <span class="nf">android_view_RenderNode_setAllowForceDark</span><span class="p">(</span><span class="n">CRITICAL_JNI_PARAMS_COMMA</span> <span class="n">jlong</span> <span class="n">renderNodePtr</span><span class="p">,</span> <span class="n">jboolean</span> <span class="n">allow</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">SET_AND_DIRTY</span><span class="p">(</span><span class="n">setAllowForceDark</span><span class="p">,</span> <span class="n">allow</span><span class="p">,</span> <span class="n">RenderNode</span><span class="o">::</span><span class="n">GENERIC</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define SET_AND_DIRTY(prop, val, dirtyFlag) \
</span><span class="cp">    (reinterpret_cast&lt;RenderNode*&gt;(renderNodePtr)-&gt;mutateStagingProperties().prop(val) \
</span><span class="cp">        ? (reinterpret_cast&lt;RenderNode*&gt;(renderNodePtr)-&gt;setPropertyFieldsDirty(dirtyFlag), true) \
</span><span class="cp">        : false)
</span></code></pre></div><p>最后这个是否允许深色模式的<code>allow</code>变量被设置到<code>RenderProperties.h</code> 中</p>
<p><strong><a href="https://cs.android.com/android/platform/superproject/+/master:frameworks/base/libs/hwui/RenderProperties.h;l=553;drc=master">frameworks/base/libs/hwui/RenderProperties.h</a></strong></p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cm">/*
</span><span class="cm"> * Data structure that holds the properties for a RenderNode
</span><span class="cm"> */</span>
<span class="k">class</span> <span class="nc">ANDROID_API</span> <span class="n">RenderProperties</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="c1">// ...
</span><span class="c1"></span>    <span class="c1">// 设置View是否允许强制深色模式
</span><span class="c1"></span>    <span class="kt">bool</span> <span class="n">setAllowForceDark</span><span class="p">(</span><span class="kt">bool</span> <span class="n">allow</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">RP_SET</span><span class="p">(</span><span class="n">mPrimitiveFields</span><span class="p">.</span><span class="n">mAllowForceDark</span><span class="p">,</span> <span class="n">allow</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// 获取View是否允许强制深色模式
</span><span class="c1"></span>    <span class="kt">bool</span> <span class="nf">getAllowForceDark</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">mPrimitiveFields</span><span class="p">.</span><span class="n">mAllowForceDark</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// ...
</span><span class="c1"></span><span class="k">private</span><span class="o">:</span>
    <span class="c1">// Rendering properties
</span><span class="c1"></span>    <span class="k">struct</span> <span class="nc">PrimitiveFields</span> <span class="p">{</span>
        <span class="c1">// ...
</span><span class="c1"></span>        <span class="c1">// 默认值为true
</span><span class="c1"></span>        <span class="kt">bool</span> <span class="n">mAllowForceDark</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="c1">// ...
</span><span class="c1"></span>    <span class="p">}</span> <span class="n">mPrimitiveFields</span><span class="p">;</span>
</code></pre></div><p>我们回头看下上面分析过的<code>RenderNode.cpp</code>的<code>prepareTreeImpl</code>流程</p>
<p><strong><a href="https://cs.android.com/android/platform/superproject/+/master:frameworks/base/libs/hwui/RenderNode.cpp;l=235;drc=master;bpv=0;bpt=1">frameworks/base/libs/hwui/RenderNode.cpp</a></strong></p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// 经过了简化处理的prepareTreeImpl逻辑
</span><span class="c1"></span><span class="kt">void</span> <span class="n">RenderNode</span><span class="o">::</span><span class="n">prepareTreeImpl</span><span class="p">(</span><span class="n">TreeObserver</span><span class="o">&amp;</span> <span class="n">observer</span><span class="p">,</span> <span class="n">TreeInfo</span><span class="o">&amp;</span> <span class="n">info</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 如果当前View不允许被ForceDark，那么info.disableForceDark值+1
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mProperties</span><span class="p">.</span><span class="n">getAllowForceDark</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">info</span><span class="p">.</span><span class="n">disableForceDark</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 同步正在处理的Render Node的Display List，实现具体深色的逻辑
</span><span class="c1"></span>    <span class="n">pushStagingDisplayListChanges</span><span class="p">(</span><span class="n">observer</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

    <span class="n">mDisplayList</span><span class="o">-&gt;</span><span class="n">prepareListAndChildren</span><span class="p">([](</span><span class="n">RenderNode</span><span class="o">*</span> <span class="n">child</span><span class="p">,</span> <span class="n">TreeObserver</span><span class="o">&amp;</span> <span class="n">observer</span><span class="p">,</span> <span class="n">TreeInfo</span><span class="o">&amp;</span> <span class="n">info</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 递归调用子节点的prepareTreeImpl。
</span><span class="c1"></span>        <span class="c1">// 递归调用之前，若父节点不允许强制深色模式，disableForceDark已经不为0，
</span><span class="c1"></span>        <span class="c1">//     子节点再设置允许强制深色模式不会使得disableForceDark的值减少，
</span><span class="c1"></span>        <span class="c1">//     因此有第三个规则：父节点设置了不允许深色模式，子节点再设置允许深色模式无效。
</span><span class="c1"></span>        <span class="c1">// 同样的，递归调用之前，若父节点允许深色模式，disableForceDark为0，
</span><span class="c1"></span>        <span class="c1">//     子节点再设置不允许强制深色模式，则disableForceDark值还是会++，不为0
</span><span class="c1"></span>        <span class="c1">//     因此有第四个规则：子节点设置不允许强制深色模式不受父节点设置允许强制深色模式影响。
</span><span class="c1"></span>        <span class="n">child</span><span class="o">-&gt;</span><span class="n">prepareTreeImpl</span><span class="p">(</span><span class="n">observer</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
      <span class="p">});</span>
    
    <span class="c1">// 递归结束后将之前设置过+1的值做回退-1恢复操作，避免影响其他兄弟结点的深色模式值判断
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mProperties</span><span class="p">.</span><span class="n">getAllowForceDark</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">info</span><span class="p">.</span><span class="n">disableForceDark</span><span class="o">--</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>可以看出，设置View的<code>forceDarkAllowed</code>最终会设置到当前<code>RenderNode</code>的<code>mProperties.allowForceDark</code>属性中，并在<code>RenderNode</code>遍历的过程中影响深色模式的执行。</p>
<p>我们可以以下面的伪代码来更直观地了解深色模式执行的流程：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// 深色模式渲染伪代码
</span><span class="c1"></span><span class="kt">int</span> <span class="n">disableDark</span> <span class="o">=</span> <span class="k">if</span> <span class="o">(</span><span class="n">themeAllowDark</span><span class="o">)</span> <span class="n">0</span> <span class="k">else</span> <span class="n">1</span><span class="o">;</span>

<span class="kt">void</span> <span class="nf">RenderNode</span><span class="o">(</span><span class="n">Node</span> <span class="n">node</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(!</span><span class="n">node</span><span class="o">.</span><span class="na">allowDark</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">disableDark</span><span class="o">++;</span>
  <span class="o">}</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">disableDark</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="n">forceDarkCurrentNode</span><span class="o">();</span>
  <span class="k">for</span> <span class="o">(</span><span class="n">child</span> <span class="o">:</span> <span class="n">node</span><span class="o">.</span><span class="na">children</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">RenderNode</span><span class="o">(</span><span class="n">child</span><span class="o">)</span>
  <span class="o">}</span>
  <span class="k">if</span> <span class="o">(!</span><span class="n">node</span><span class="o">.</span><span class="na">allowDark</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">disableDark</span><span class="o">--;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>至此，我们分析完所有强制深色模式的原理。<strong>总结一下，主题默认不会强制深色，若主题设置了强制深色，则遍历View树对其节点进行强制深色转换。碰到某个View不希望被强制深色，则包括它和它的所有子节点都不会被强制深色。</strong></p>
<h2 id="总结">总结</h2>
<p>到这里，我们了解了可以通过设置<code>-night</code>资源以及判断当前颜色模式来自定义切换主题、色值、图片和动画的颜色，也从源代码角度了解Force Dark的原理和生效规则。</p>
<h2 id="demo">Demo</h2>
<p>上述提到的代码可以到这个<a href="https://github.com/shenguojun/AndroidDarkThemeDemo">Github项目</a>下载</p>
<h2 id="参考">参考</h2>
<ol>
<li><a href="https://developer.android.com/guide/topics/ui/look-and-feel/darktheme#top_of_page">Google Developers - Dark Theme</a></li>
<li><a href="https://material.io/develop/android/theming/dark">Material Design - Dark Theme</a></li>
<li><a href="https://material.io/design/color/the-color-system.html">Material Design - The color system</a></li>
<li><a href="https://juejin.im/post/6844904173788463112#heading-15">Android 10 暗黑模式适配，你需要知道的一切</a></li>
<li><a href="https://www.raywenderlich.com/6488033-android-10-dark-theme-getting-started">Android 10 Dark Theme: Getting Started</a></li>
<li><a href="https://medium.com/androiddevelopers/android-styling-themes-vs-styles-ebe05f917578">Android styling: themes vs styles</a></li>
<li><a href="https://medium.com/androiddevelopers/android-styling-common-theme-attributes-8f7c50c9eaba">Android styling: common theme attributes</a></li>
<li><a href="https://medium.com/androiddevelopers/android-styling-prefer-theme-attributes-412caa748774">Android Styling: prefer theme attributes</a></li>
<li><a href="http://airbnb.io/lottie/#/android?id=dynamic-properties">Lottie - Dynamic Properties</a></li>
<li><a href="https://medium.com/comparethemarket/lottie-on-android-part-3-dynamic-properties-8aa566ba4fbf">Lottie on Android: Part 3 — Dynamic properties</a></li>
<li><a href="https://dev.mi.com/console/doc/detail?pId=2298">MIUI 深色模式适配说明</a></li>
<li><a href="https://open.oppomobile.com/wiki/doc#id=10658">OPPO 暗色模式适配说明</a></li>
<li><a href="https://www.jianshu.com/p/5005969bf37a">Android Q深色模式源码解析</a></li>
<li><a href="https://proandroiddev.com/android-dark-theme-implementation-recap-4fcffb0c4bff">Moving to the Dark Side: Dark Theme Recap</a></li>
<li><a href="https://blog.csdn.net/luoshengyang/article/details/45769759">Android应用程序UI硬件加速渲染环境初始化过程分析</a></li>
<li><a href="https://blog.csdn.net/luoshengyang/article/details/45943255">Android应用程序UI硬件加速渲染的Display List构建过程分析</a></li>
<li><a href="https://blog.csdn.net/Luoshengyang/article/details/46281499">Android应用程序UI硬件加速渲染的Display List渲染过程分析</a></li>
<li><a href="https://www.youtube.com/watch?v=zdQRIYOST64&amp;ab_channel=AndroidDevelopers">Drawn out: how Android renders (Google I/O &lsquo;18)</a></li>
<li><a href="https://www.yuque.com/beesx/beesandroid/qh7ohm#NkEJZ">深入理解Android的渲染机制</a></li>
<li><a href="https://api.skia.org/">SKIA api</a></li>
<li><a href="https://cs.android.com/">Android Code Search</a></li>
</ol>


        
          <div class="blog-tags">
            
              <a href="https://shenguojun.github.io//tags/android/">android</a>&nbsp;
            
          </div>
        

        
            <hr/>
            <section id="social-share">
              <div class="list-inline footer-links">
                

<div class="share-box" aria-hidden="true">
    <ul class="share">
      
      <li>
        <a href="//twitter.com/share?url=https%3a%2f%2fshenguojun.github.io%2fpost%2fandroid-dark-mode%2f&amp;text=Android%e6%b7%b1%e8%89%b2%e6%a8%a1%e5%bc%8f%e9%80%82%e9%85%8d%e5%8e%9f%e7%90%86%e5%88%86%e6%9e%90&amp;via=" target="_blank" title="Share on Twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fshenguojun.github.io%2fpost%2fandroid-dark-mode%2f" target="_blank" title="Share on Facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//reddit.com/submit?url=https%3a%2f%2fshenguojun.github.io%2fpost%2fandroid-dark-mode%2f&amp;title=Android%e6%b7%b1%e8%89%b2%e6%a8%a1%e5%bc%8f%e9%80%82%e9%85%8d%e5%8e%9f%e7%90%86%e5%88%86%e6%9e%90" target="_blank" title="Share on Reddit">
          <i class="fab fa-reddit"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fshenguojun.github.io%2fpost%2fandroid-dark-mode%2f&amp;title=Android%e6%b7%b1%e8%89%b2%e6%a8%a1%e5%bc%8f%e9%80%82%e9%85%8d%e5%8e%9f%e7%90%86%e5%88%86%e6%9e%90" target="_blank" title="Share on LinkedIn">
          <i class="fab fa-linkedin"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fshenguojun.github.io%2fpost%2fandroid-dark-mode%2f&amp;title=Android%e6%b7%b1%e8%89%b2%e6%a8%a1%e5%bc%8f%e9%80%82%e9%85%8d%e5%8e%9f%e7%90%86%e5%88%86%e6%9e%90" target="_blank" title="Share on StumbleUpon">
          <i class="fab fa-stumbleupon"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fshenguojun.github.io%2fpost%2fandroid-dark-mode%2f&amp;description=Android%e6%b7%b1%e8%89%b2%e6%a8%a1%e5%bc%8f%e9%80%82%e9%85%8d%e5%8e%9f%e7%90%86%e5%88%86%e6%9e%90" target="_blank" title="Share on Pinterest">
          <i class="fab fa-pinterest"></i>
        </a>
      </li>
    </ul>
  </div>
  

              </div>
            </section>
        

        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://shenguojun.github.io/post/flutter-learning-note/" data-toggle="tooltip" data-placement="top" title="Flutter学习笔记——用户界面">&larr; Previous Post</a>
            </li>
          
          
        </ul>
      


      
        
        
      

    </div>
  </div>
</div>

      
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="mailto:junguoshen@yeah.net" title="Email me">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://github.com/shenguojun" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://linkedin.com/in/guojunshen" title="LinkedIn">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          <li>
            <a href="" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              申国骏
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2020
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://shenguojun.github.io/">Lawrence&#39;s Blog</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.68.3</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="https://shenguojun.github.io/js/main.js"></script>
<script src="https://shenguojun.github.io/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> $(document).ready(function() {$("pre.chroma").css("padding","0");}); </script><script> renderMathInElement(document.body); </script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://shenguojun.github.io/js/load-photoswipe.js"></script>









    
  </body>
</html>

